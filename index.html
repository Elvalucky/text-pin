<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Shared AR Text â€” Marker + Click + Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.js"></script>

  <!-- é¢„åŠ è½½ Firebase æ¨¡å— -->
  <script type="module">
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  </script>

  <style>
    html, body { 
      margin: 0; padding: 0; height: 100dvh; background: #000; overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; 
    }

    #scanStatus {
      position: fixed; top: 8px; left: 8px; z-index: 20; 
      background: rgba(0,0,0,.75); color: #fff; padding: 8px 12px; 
      border-radius: 12px; font-size: 13px; backdrop-filter: blur(8px);
      transition: all 0.3s ease;
    }
    #scanStatus.success { background: rgba(34,197,94,.9); }
    #scanStatus.error { background: rgba(239,68,68,.9); }
    
    #net { 
      position: fixed; top: 8px; right: 8px; z-index: 20; 
      background: rgba(0,0,0,.6); color: #fff; padding: 6px 10px; 
      border-radius: 10px; font-size: 12px; 
    }
    
    #debug {
      position: fixed; top: 50px; left: 8px; z-index: 20; 
      background: rgba(0,0,0,.6); color: #fff; padding: 6px 10px; 
      border-radius: 10px; font-size: 11px; max-width: 280px; 
      line-height: 1.35; white-space: pre-wrap; max-height: 150px; 
      overflow-y: auto;
    }

    #ui {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 20;
      background: rgba(0,0,0,.75); color: #fff; 
      padding: 10px 10px calc(12px + env(safe-area-inset-bottom));
      box-shadow: 0 -8px 24px rgba(0,0,0,.25); backdrop-filter: blur(8px);
      display: none; transition: all 0.3s ease;
    }
    
    #ui form { 
      display: grid; grid-template-columns: 1fr minmax(70px,110px) auto; 
      gap: 8px; align-items: end; 
    }
    
    #ui label { 
      display: flex; flex-direction: column; font-size: 12px; opacity: .95; 
    }
    
    #ui input { 
      height: 36px; border-radius: 10px; border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.1); color: #fff; padding: 6px 10px;
      transition: all 0.2s ease;
    }
    
    #ui input:focus {
      border-color: rgba(77, 170, 221, 0.5);
      background: rgba(255,255,255,.15);
      outline: none;
    }
    
    #ui button { 
      height: 36px; border: none; border-radius: 10px; 
      background: #4ad; color: #002; font-weight: 700; padding: 0 16px;
      transition: all 0.2s ease; cursor: pointer;
    }
    
    #ui button:hover:not(:disabled) { background: #3ac; transform: translateY(-1px); }
    #ui button:disabled { opacity: 0.6; cursor: not-allowed; }
    
    #status { margin-top: 6px; font-size: 12px; opacity: .85; }

    /* ç›¸æœºè§†é¢‘åœ¨åº•ï¼ŒWebGL ç”»å¸ƒåœ¨ä¸Š */
    video, #arjs-video, video#arjs-video {
      position: fixed !important; top: 0 !important; left: 0 !important;
      width: 100vw !important; height: 100vh !important; object-fit: cover !important;
      z-index: 0 !important; background: #000 !important; 
      display: block !important; visibility: visible !important; opacity: 1 !important;
    }
    
    canvas.a-canvas { 
      position: fixed !important; top: 0 !important; left: 0 !important; 
      z-index: 1 !important; background: transparent !important; 
    }

    .a-enter-vr-button, .a-enter-ar-button, .a-orientation-modal { 
      display: none !important; 
    }
    
    * { 
      -webkit-touch-callout: none; -webkit-user-select: none; 
      user-select: none; -webkit-tap-highlight-color: transparent; 
    }

    /* å¼€å§‹æŒ‰é’® */
    #startAR {
      position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 30;
      height: 48px; border: none; border-radius: 12px; 
      background: #4ad; color: #002; font-weight: 800; font-size: 16px; 
      box-shadow: 0 8px 24px rgba(0,0,0,.35); cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #startAR:hover { background: #3ac; transform: translateY(-2px); }
    #startAR:active { transform: translateY(0); }
  </style>
</head>
<body>
  <div id="scanStatus">ğŸ‘‹ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ AR</div>
  <div id="net">ğŸŸ¢ åœ¨çº¿</div>
  <div id="debug">ç­‰å¾…å¯åŠ¨â€¦</div>

  <button id="startAR">å¼€å§‹ AR</button>

  <a-scene id="scene" style="display:none"
           embedded vr-mode-ui="enabled:false"
           renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true">
    
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0.5 1 0.5"></a-entity>

    <!-- Hiro Marker -->
    <a-marker id="marker-hiro" preset="hiro" emitevents="true" smooth="true" 
              smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <!-- æŠ•ç‚¹å¹³é¢ï¼ˆç”¨äºç‚¹å‡»æ‹¾å–ï¼‰ -->
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" 
               material="opacity:0; transparent:true"></a-plane>
      <!-- ä¸­å¿ƒæŒ‡ç¤ºæŸ±ï¼ˆé»˜è®¤æ˜¾ç¤ºåœ¨æ ‡è®°ä¸­å¿ƒç¨ä¸Šæ–¹ï¼‰ -->
      <a-box id="indicator-hiro" position="0 0.12 0" width="0.15" height="0.24" depth="0.15"
             material="color:#19d47d; opacity:0.9" 
             animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"></a-box>
    </a-marker>

    <!-- Kanji Marker -->
    <a-marker id="marker-kanji" preset="kanji" emitevents="true" smooth="true" 
              smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" 
               material="opacity:0; transparent:true"></a-plane>
      <a-box id="indicator-kanji" position="0 0.12 0" width="0.15" height="0.24" depth="0.15"
             material="color:#ffd166; opacity:0.9"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"></a-box>
    </a-marker>

    <!-- å…‰çº¿æ‹¾å– -->
    <a-entity id="mouse" cursor="rayOrigin: mouse" 
              raycaster="objects: .dropzone; interval: 0"></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="ui">
    <form id="form">
      <label>Text
        <input id="msg" placeholder="è¾“å…¥æ–‡æœ¬â€¦" maxlength="80" />
      </label>
      <label>Scale
        <input id="scale" type="number" step="0.1" value="1.0" min="0.1" max="3.0" inputmode="decimal" />
      </label>
      <button type="submit" id="submit">æäº¤ / Pin</button>
    </form>
    <div id="status">æœªé€‰ä½ç½®</div>
  </div>

  <script type="module">
    /******** å¯è°ƒå‚æ•° ********/
    const CONFIG = {
      PREVIEW_DEFAULT_TEXT: 'hello',      // æœªè¾“å…¥æ—¶ï¼Œé¢„è§ˆæ˜¾ç¤ºè¿™ä¸ªå ä½æ–‡å­—
      USE_INDICATOR: true,                // æ˜¯å¦æ˜¾ç¤º"å°å·æ–œæŸ±"ä¸­å¿ƒæŒ‡ç¤º
      INDICATOR_MODE: 'center',           // 'center' | 'follow' æ–œæŸ±æ˜¾ç¤ºåœ¨æ ‡è®°ä¸­å¿ƒï¼Œæˆ–è·Ÿéšç‚¹å‡»
      INDICATOR_HEIGHT_OFFSET: 0.12,      // æ–œæŸ±ç¦»å¹³é¢çš„é«˜åº¦
      DETECTION_THRESHOLD: 3,             // è¿ç»­æ£€æµ‹åˆ°å¤šå°‘æ¬¡æ‰è®¤ä¸ºè¯†åˆ«
      DETECTION_TIMEOUT: 1500,            // å¤šå°‘æ¯«ç§’æœªæ£€æµ‹åˆ°å°±è®¤ä¸ºä¸¢å¤±
      POLL_INTERVAL: 150                  // è½®è¯¢é—´éš”ï¼ˆæ¯«ç§’ï¼‰
    };

    /******** DOM & çŠ¶æ€ç®¡ç† ********/
    const DOM = {
      scan: document.getElementById('scanStatus'),
      net: document.getElementById('net'),
      debug: document.getElementById('debug'),
      scene: document.getElementById('scene'),
      mouse: document.getElementById('mouse'),
      form: document.getElementById('form'),
      msg: document.getElementById('msg'),
      scale: document.getElementById('scale'),
      status: document.getElementById('status'),
      btn: document.getElementById('submit'),
      start: document.getElementById('startAR')
    };

    // ç½‘ç»œçŠ¶æ€ç®¡ç†
    const updateNetStatus = (online) => {
      DOM.net.textContent = online ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
    };
    updateNetStatus(navigator.onLine);
    addEventListener('online', () => updateNetStatus(true));
    addEventListener('offline', () => updateNetStatus(false));

    // è°ƒè¯•ä¿¡æ¯æ›´æ–°
    const updateDebug = (text) => {
      DOM.debug.textContent = text;
    };

    // éœ‡åŠ¨åé¦ˆ
    const vibrate = (duration = 20) => {
      try {
        navigator.vibrate && navigator.vibrate(duration);
      } catch (e) {
        // å¿½ç•¥é”™è¯¯
      }
    };

    // æ‰«æçŠ¶æ€æ›´æ–°ï¼ˆèŠ‚æµï¼‰
    let scanTimer = null;
    let scanCache = '';
    const updateScanStatus = (text, className = '') => {
      if (text === scanCache) return;
      clearTimeout(scanTimer);
      scanTimer = setTimeout(() => {
        scanCache = text;
        DOM.scan.className = className;
        DOM.scan.textContent = text;
      }, 100);
    };

    /******** AR å¯åŠ¨ç®¡ç† ********/
    const AR_CONFIG = `
      sourceType: webcam;
      videoTexture: false;
      detectionMode: mono;
      sourceWidth: 1280;
      sourceHeight: 720;
      maxDetectionRate: 60;
      debugUIEnabled: false
    `;

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

    const forceVideoVisible = () => {
      const videos = document.querySelectorAll('video');
      videos.forEach(video => {
        video.setAttribute('playsinline', 'true');
        video.setAttribute('webkit-playsinline', 'true');
        video.muted = true;
        video.style.display = 'block';
        video.style.visibility = 'visible';
        video.style.opacity = '1';
      });
      
      const canvas = document.querySelector('.a-canvas');
      if (canvas) {
        canvas.style.zIndex = '1';
        canvas.style.background = 'transparent';
      }
    };

    DOM.start.addEventListener('click', async () => {
      try {
        updateScanStatus('ğŸ“· æ­£åœ¨è¯·æ±‚ç›¸æœºæƒé™â€¦');
        
        // è¯·æ±‚ç›¸æœºæƒé™
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        stream.getTracks().forEach(track => track.stop());
        await new Promise(resolve => setTimeout(resolve, 300));

        // å¯åŠ¨ AR
        DOM.scene.setAttribute('arjs', AR_CONFIG);
        DOM.scene.style.display = 'block';
        DOM.start.style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        
        updateScanStatus('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanjiâ€¦');

        setTimeout(forceVideoVisible, 600);
        if (isIOS) {
          [1500, 3000, 5000].forEach(delay => 
            setTimeout(forceVideoVisible, delay)
          );
        }
      } catch (error) {
        console.error('ARå¯åŠ¨å¤±è´¥:', error);
        updateScanStatus('âŒ éœ€è¦æ‘„åƒå¤´æƒé™æ‰èƒ½ä½¿ç”¨ AR', 'error');
        alert('éœ€è¦ç›¸æœºæƒé™æ‰èƒ½ä½¿ç”¨ AR');
      }
    });

    /******** æ ‡è®°è¯†åˆ«çŠ¶æ€ç®¡ç† ********/
    const markerState = {
      hiro: { detected: false, lastSeen: 0, consecutiveVisible: 0, lastClickPos: null },
      kanji: { detected: false, lastSeen: 0, consecutiveVisible: 0, lastClickPos: null }
    };

    const markers = {
      hiro: document.getElementById('marker-hiro'),
      kanji: document.getElementById('marker-kanji')
    };

    const updateOverallScanStatus = () => {
      const activeMarkers = Object.entries(markerState)
        .filter(([_, state]) => state.detected)
        .map(([name]) => name.charAt(0).toUpperCase() + name.slice(1));
        
      if (activeMarkers.length > 0) {
        updateScanStatus(`âœ… å·²è¯†åˆ« ${activeMarkers.join(' / ')}ï¼Œå¯ç‚¹é€‰æ”¾ç½®`, 'success');
      } else {
        updateScanStatus('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanjiâ€¦');
      }
    };

    const onMarkerFound = (name) => {
      const key = name.toLowerCase();
      const state = markerState[key];
      
      if (!state.detected) {
        state.detected = true;
        vibrate(15);
        updateScanStatus(`âœ… å·²è¯†åˆ« ${name}ï¼Œè¯·åœ¨æ ‡è®°å†…è½»ç‚¹é€‰æ‹©ä½ç½®`, 'success');
      }
      
      state.lastSeen = Date.now();
      state.consecutiveVisible++;
      updateOverallScanStatus();
    };

    const onMarkerLost = (name) => {
      const key = name.toLowerCase();
      const state = markerState[key];
      
      if (state.detected) {
        state.detected = false;
        state.consecutiveVisible = 0;
        updateOverallScanStatus();
      }
    };

    // ç»‘å®šæ ‡è®°äº‹ä»¶
    markers.hiro.addEventListener('markerFound', () => onMarkerFound('Hiro'));
    markers.kanji.addEventListener('markerFound', () => onMarkerFound('Kanji'));
    markers.hiro.addEventListener('markerLost', () => onMarkerLost('Hiro'));
    markers.kanji.addEventListener('markerLost', () => onMarkerLost('Kanji'));

    // è½®è¯¢æ£€æµ‹ï¼ˆå¢å¼ºç¨³å®šæ€§ï¼‰
    let pollCount = 0;
    setInterval(() => {
      pollCount++;
      const now = Date.now();
      
      const visibility = {
        hiro: !!(markers.hiro.object3D && markers.hiro.object3D.visible),
        kanji: !!(markers.kanji.object3D && markers.kanji.object3D.visible)
      };

      ['hiro', 'kanji'].forEach(name => {
        const state = markerState[name];
        
        if (visibility[name]) {
          state.lastSeen = now;
          state.consecutiveVisible++;
          
          if (!state.detected && state.consecutiveVisible >= CONFIG.DETECTION_THRESHOLD) {
            onMarkerFound(name.charAt(0).toUpperCase() + name.slice(1));
          }
        } else {
          state.consecutiveVisible = 0;
          
          if (state.detected && now - state.lastSeen > CONFIG.DETECTION_TIMEOUT) {
            onMarkerLost(name.charAt(0).toUpperCase() + name.slice(1));
          }
        }
      });

      updateDebug(`è½®è¯¢: ${pollCount}
Hiro: ${visibility.hiro ? 'âœ…å¯è§' : 'âŒéšè—'} (è¿ç»­${markerState.hiro.consecutiveVisible}) çŠ¶æ€: ${markerState.hiro.detected ? 'å·²è¯†åˆ«' : 'æœªè¯†åˆ«'}
Kanji: ${visibility.kanji ? 'âœ…å¯è§' : 'âŒéšè—'} (è¿ç»­${markerState.kanji.consecutiveVisible}) çŠ¶æ€: ${markerState.kanji.detected ? 'å·²è¯†åˆ«' : 'æœªè¯†åˆ«'}`);
    }, CONFIG.POLL_INTERVAL);

    /******** é¢„è§ˆä¸äº¤äº’ç®¡ç† ********/
    const USER_ID = 'user_' + Math.random().toString(36).slice(2, 8);
    let currentSelection = { anchor: null, position: null };

    // å·¥å…·å‡½æ•°
    const findMarkerElement = (element) => {
      let parent = element;
      while (parent && parent.tagName) {
        if (parent.tagName.toLowerCase() === 'a-marker') return parent;
        parent = parent.parentEl;
      }
      return null;
    };

    const round2 = (n) => Math.round(n * 100) / 100;
    const normalizePosition = (x, y, z) => [round2(x), Math.max(round2(y), 0) + 0.001, round2(z)];
    const getPreviewText = () => DOM.msg.value.trim() || CONFIG.PREVIEW_DEFAULT_TEXT;

    // æŒ‡ç¤ºå™¨ä½ç½®æ›´æ–°
    const updateIndicatorPosition = (anchor) => {
      if (!CONFIG.USE_INDICATOR) return;
      
      const indicator = document.getElementById(`indicator-${anchor}`);
      if (!indicator) return;
      
      if (CONFIG.INDICATOR_MODE === 'center') {
        indicator.setAttribute('position', `0 ${CONFIG.INDICATOR_HEIGHT_OFFSET} 0`);
      }
      // follow æ¨¡å¼ä¼šåœ¨ç‚¹å‡»æ—¶æ›´æ–°ä½ç½®
    };

    // é¢„è§ˆæ˜¾ç¤º
    const showPreview = (anchor, position, confirmed = false) => {
      const parent = document.getElementById(`marker-${anchor}`);
      if (!parent) return;

      // åœ†ç¯æŒ‡ç¤ºå™¨
      let cursor = document.getElementById(`cursor-${anchor}`);
      if (!cursor) {
        cursor = document.createElement('a-entity');
        cursor.id = `cursor-${anchor}`;
        parent.appendChild(cursor);
      }
      
      cursor.setAttribute('rotation', '-90 0 0');
      cursor.setAttribute('geometry', confirmed ? 
        'primitive:ring; radiusInner:0.015; radiusOuter:0.025' : 
        'primitive:ring; radiusInner:0.012; radiusOuter:0.02'
      );
      cursor.setAttribute('material', confirmed ? 
        'color:#00FF00; opacity:1' : 
        'color:#FFD166; opacity:.95'
      );
      cursor.setAttribute('position', `${position[0]} ${position[1]} ${position[2]}`);

      // æ–‡å­—é¢„è§ˆ
      let preview = document.getElementById(`preview-${anchor}`);
      if (!preview) {
        preview = document.createElement('a-entity');
        preview.id = `preview-${anchor}`;
        parent.appendChild(preview);
      }
      
      const baseColor = anchor === 'hiro' ? '#90EE90' : '#FFD166';
      const textColor = confirmed ? '#00FF00' : baseColor;
      const scale = parseFloat(DOM.scale.value || '1') || 1;
      
      preview.setAttribute('rotation', '-90 0 0');
      preview.setAttribute('text', 
        `value:${confirmed ? 'âœ“ ' : ''}${getPreviewText()}; align:center; width:1.8; color:${textColor}; wrapCount:24`
      );
      preview.setAttribute('material', 'opacity:.9; transparent:true');
      preview.setAttribute('scale', `${scale} ${scale} ${scale}`);
      preview.setAttribute('position', `${position[0]} ${position[1]} ${position[2]}`);

      // è·Ÿéšæ¨¡å¼ä¸‹æ›´æ–°æŒ‡ç¤ºå™¨ä½ç½®
      if (CONFIG.USE_INDICATOR && CONFIG.INDICATOR_MODE === 'follow') {
        const indicator = document.getElementById(`indicator-${anchor}`);
        if (indicator) {
          indicator.setAttribute('position', 
            `${position[0]} ${position[1] + CONFIG.INDICATOR_HEIGHT_OFFSET} ${position[2]}`
          );
        }
      }
    };

    // ç‚¹å‡»äº‹ä»¶å¤„ç†
    DOM.scene.addEventListener('click', () => {
      const raycaster = DOM.mouse.components.raycaster;
      if (!raycaster || !raycaster.intersections?.length) return;
      
      const hit = raycaster.intersections[0];
      if (!hit.object?.el?.classList?.contains('dropzone')) return;

      const marker = findMarkerElement(hit.object.el);
      if (!marker) return;
      
      if (!marker.object3D?.visible) {
        updateScanStatus('âš ï¸ æ ‡è®°æœªè¢«ç¨³å®šè¯†åˆ«ï¼Œè¯·æŠŠæ•´å¼ æ ‡è®°æ”¾å…¥å–æ™¯æ¡†', 'error');
        setTimeout(updateOverallScanStatus, 1200);
        return;
      }

      const anchor = (marker.id === 'marker-hiro') ? 'hiro' : 'kanji';
      const localPosition = marker.object3D.worldToLocal(hit.point.clone());
      const position = normalizePosition(localPosition.x, localPosition.y, localPosition.z);

      markerState[anchor].lastClickPos = position;
      currentSelection = { anchor, position };
      
      DOM.status.textContent = `å·²é€‰ï¼š${anchor} (${position.map(n => n.toFixed(2)).join(', ')})`;
      updateScanStatus('âœ… ä½ç½®å·²é€‰ï¼šå¯åœ¨ä¸‹æ–¹è¾“å…¥æ–‡å­—å¹¶æäº¤', 'success');
      
      showPreview(anchor, position);
      vibrate(30);
    });

    // è¾“å…¥æ¡†å®æ—¶é¢„è§ˆ
    DOM.msg.addEventListener('input', () => {
      if (!currentSelection.anchor || !currentSelection.position) return;
      showPreview(currentSelection.anchor, currentSelection.position);
    });

    DOM.scale.addEventListener('input', () => {
      if (!currentSelection.anchor || !currentSelection.position) return;
      showPreview(currentSelection.anchor, currentSelection.position);
    });

    // æ ‡è®°è¯†åˆ«æ—¶åˆå§‹åŒ–æŒ‡ç¤ºå™¨
    ['hiro', 'kanji'].forEach(anchor => {
      const element = document.getElementById(`marker-${anchor}`);
      element.addEventListener('markerFound', () => updateIndicatorPosition(anchor));
    });

    /******** Firebase å®æ—¶åŒæ­¥ ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, onSnapshot, 
      orderBy, query, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYsPxSPvpv8mPQdVGJuzE2TKZ0qY6e608",
      authDomain: "ar-maker-share.firebaseapp.com",
      projectId: "ar-maker-share",
      storageBucket: "ar-maker-share.appspot.com",
      messagingSenderId: "68968164615",
      appId: "1:68968164615:web:c56d3c17046ff51ebf29a2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const pinsCollection = collection(db, "pins");

    // å®æ—¶ç›‘å¬æ•°æ®å˜åŒ–
    const pinsQuery = query(pinsCollection, orderBy('ts', 'asc'));
    onSnapshot(pinsQuery, (snapshot) => {
      snapshot.docChanges().forEach(change => {
        const data = change.doc.data();
        if (data.mode !== 'arjs') return;

        const anchor = (data.anchor === 'kanji') ? 'kanji' : 'hiro';
        const parent = document.getElementById(`marker-${anchor}`);
        if (!parent) return;

        if (change.type === 'removed') {
          const oldElement = document.getElementById(`pin-${change.doc.id}`);
          if (oldElement) oldElement.remove();
          return;
        }

        let element = document.getElementById(`pin-${change.doc.id}`);
        if (!element) {
          element = document.createElement('a-entity');
          element.id = `pin-${change.doc.id}`;
          parent.appendChild(element);
        }

        const [x, y, z] = data.pos || [0, 0, 0];
        element.setAttribute('position', `${x} ${y} ${z}`);

        if (data.modelUrl) {
          element.removeAttribute('text');
          const scale = data.scale || 1;
          element.setAttribute('gltf-model', data.modelUrl);
          element.setAttribute('scale', `${scale} ${scale} ${scale}`);
        } else {
          const isOwn = data.userId === USER_ID;
          const baseColor = anchor === 'hiro' ? '#90EE90' : '#FFD166';
          const textColor = isOwn ? baseColor : '#ccc';
          const scale = data.scale || 1;

          element.setAttribute('rotation', '-90 0 0');
          element.setAttribute('text', 
            `value:${data.text || ''}; align:center; width:1.8; color:${textColor}; wrapCount:24`
          );
          element.setAttribute('scale', `${scale} ${scale} ${scale}`);
        }
      });
    });

    // ä¿å­˜æ•°æ®åˆ° Firebase
    const savePin = async ({ anchor, position, text, scale }) => {
      return await addDoc(pinsCollection, {
        mode: 'arjs',
        anchor,
        pos: position,
        text,
        scale,
        userId: USER_ID,
        ts: serverTimestamp()
      });
    };

    // è¡¨å•æäº¤å¤„ç†
    DOM.form.addEventListener('submit', async (event) => {
      event.preventDefault();
      
      const text = DOM.msg.value.trim();
      const scale = parseFloat(DOM.scale.value || '1') || 1;
      
      if (!text) {
        alert('è¯·è¾“å…¥æ–‡æœ¬');
        return;
      }
      
      if (!currentSelection.position) {
        alert('è¯·å…ˆåœ¨æ ‡è®°å†…ç‚¹å‡»é€‰æ‹©ä½ç½®');
        return;
      }
      
      if (!navigator.onLine) {
        alert('ç¦»çº¿çŠ¶æ€ï¼Œæ— æ³•æäº¤');
        return;
      }

      const { anchor, position } = currentSelection;
      
      try {
        DOM.btn.disabled = true;
        showPreview(anchor, position, true);
        updateScanStatus('â³ æ­£åœ¨æäº¤â€¦');
        
        await savePin({ anchor, position, text, scale });
        
        updateScanStatus('âœ… å·²æäº¤ï¼Œå…¶ä»–äººä¹Ÿèƒ½çœ‹åˆ°', 'success');
        DOM.msg.value = '';
        vibrate(40);
        
        setTimeout(() => {
          // æ¸…ç†é¢„è§ˆå…ƒç´ 
          ['preview-', 'cursor-'].forEach(prefix => {
            const element = document.getElementById(prefix + anchor);
            if (element) element.remove();
          });
          DOM.status.textContent = 'å°±ç»ª';
        }, 1600);
        
        currentSelection = { anchor: null, position: null };
      } catch (error) {
        console.error('æäº¤å¤±è´¥:', error);
        updateScanStatus('âŒ æäº¤å¤±è´¥', 'error');
        showPreview(anchor, position, false);
      } finally {
        setTimeout(() => {
          DOM.btn.disabled = false;
          updateOverallScanStatus();
        }, 800);
      }
    });

    // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¼ºåˆ¶æ˜¾ç¤ºè§†é¢‘
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        setTimeout(forceVideoVisible, 400);
      }
    });
  </script>
</body>
</html>
