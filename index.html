<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Adaptive AR Text Pin — WebXR + AR.js</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <!-- AR.js for A-Frame (marker fallback) -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
  <style>
    :root { --ui-bg: rgba(0,0,0,.6); }
    html, body { margin:0; height:100dvh; background:#000; overflow:hidden; }

    /* 画面区域：填满顶部到底部 UI 上沿 */
    #stage {
      position: fixed; inset: 0 0 auto 0; /* top/left/right = 0, bottom 动态用 JS 改 */
      background:#000; z-index: 1;
    }
    /* 让嵌入场景铺满 #stage */
    #stage a-scene { width:100%; height:100%; display:block; }

    /* 顶部提示/开始按钮 */
    #hint{position:fixed;top:8px;left:8px;background:rgba(0,0,0,.55);color:#fff;
      padding:8px 10px;border-radius:10px;font:13px system-ui;z-index:10}
    #startAR{position:fixed;top:12px;right:12px;z-index:11;background:#fff;color:#111;
      border:0;border-radius:12px;padding:10px 14px;font-weight:700}

    /* 底部输入栏 */
    #ui{
      position: fixed; left:0; right:0; bottom:0;
      background:var(--ui-bg); color:#fff; z-index: 20;
      font:14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      padding:10px 10px calc(12px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
    }
    #ui form{display:grid;grid-template-columns:1fr minmax(76px,140px) auto;gap:8px;align-items:end}
    #ui label{display:flex;flex-direction:column;font-size:12px;opacity:.95}
    #ui input{height:36px;border-radius:10px;border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1);color:#fff;padding:6px 10px}
    #ui button{height:36px;border:none;border-radius:10px;background:#4ad;font-weight:700;
      padding:0 16px;color:#002;cursor:pointer}

    #mode-webxr, #mode-arjs{display:none}
  </style>
</head>
<body>
  <div id="hint">Detecting capabilities…</div>

  <!-- 顶部画面区域（上方） -->
  <div id="stage">
    <!-- MODE 1: WebXR -->
    <div id="mode-webxr">
      <button id="startAR">Start AR</button>
      <a-scene
        renderer="colorManagement:true; physicallyCorrectLights:true"
        webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: body"
        vr-mode-ui="enabled:false"
        embedded>
        <a-entity light="type: ambient; intensity: 0.7"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="0.5 1 0.5"></a-entity>

        <!-- 命中光标 -->
        <a-entity id="reticle" visible="false" rotation="-90 0 0">
          <a-ring radius-inner="0.04" radius-outer="0.06" material="opacity:0.9"></a-ring>
          <a-entity position="0 0 0.001">
            <a-circle radius="0.004" material="opacity:0.9"></a-circle>
          </a-entity>
        </a-entity>

        <a-entity id="text-webxr" text="value:; align:center; width:2; color:#FFD166"
                  position="0 0 -1" visible="false"></a-entity>
        <a-entity camera></a-entity>
      </a-scene>
    </div>

    <!-- MODE 2: AR.js -->
    <div id="mode-arjs">
      <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;"
               renderer="colorManagement:true; physicallyCorrectLights:true"
               vr-mode-ui="enabled:false">
        <a-entity light="type: ambient; intensity: 0.6"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="0.5 1 0.5"></a-entity>

        <a-marker id="marker-hiro" preset="hiro">
          <a-plane class="dropzone" width="2" height="2" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
          <a-entity id="text-hiro" text="value:; align:center; width:1.8; color:#90EE90" position="0 0 0" rotation="-90 0 0"></a-entity>
        </a-marker>

        <a-marker id="marker-kanji" preset="kanji">
          <a-plane class="dropzone" width="2" height="2" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
          <a-entity id="text-kanji" text="value:; align:center; width:1.8; color:#FFD166" position="0 0 0" rotation="-90 0 0"></a-entity>
        </a-marker>

        <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .dropzone; interval: 0"></a-entity>
        <a-entity camera></a-entity>
      </a-scene>
    </div>
  </div>

  <!-- 底部输入栏（下方一条） -->
  <div id="ui">
    <form id="form">
      <label>Text
        <input id="msg" placeholder="Type message…" maxlength="80" />
      </label>
      <label>Scale
        <input id="scale" value="1.0" />
      </label>
      <button type="submit">Confirm / Update</button>
    </form>
  </div>

  <script>
    // ---- 动态布局：让画面区域避开底部 UI ----
    const stage = document.getElementById('stage');
    const ui = document.getElementById('ui');
    function layout(){
      const h = ui.offsetHeight || 80;
      stage.style.bottom = h + 'px';     // 画面到底部 UI 的距离
    }
    addEventListener('load', layout);
    addEventListener('resize', layout);
    // 输入法弹起时也重算
    ['focus','blur','input'].forEach(ev => ui.addEventListener(ev, layout, true));

    // ---------- 能力检测 ----------
    async function supportsWebXRHitTest(){
      if(!('xr' in navigator)) return false;
      try{ return !!(await navigator.xr.isSessionSupported('immersive-ar')); }
      catch(e){ return false; }
    }
    const $hint = document.getElementById('hint');
    const $modeWebXR = document.getElementById('mode-webxr');
    const $modeARJS = document.getElementById('mode-arjs');

    (async ()=>{
      if (await supportsWebXRHitTest()){
        $modeWebXR.style.display = 'block';
        $hint.textContent = 'WebXR：点击右上角 Start AR，点地面放置文本。';
        initWebXR();
      } else {
        $modeARJS.style.display = 'block';
        $hint.textContent = 'AR.js：对准 Hiro/Kanji 标记，点击标记平面放置文本。';
        initARJS();
      }
    })();

    // ---------- Shared UI state ----------
    const state = JSON.parse(localStorage.getItem('adaptive-ar-text')||'{}');
    function persist(){ localStorage.setItem('adaptive-ar-text', JSON.stringify(state)); }
    const $form = document.getElementById('form');
    const $msg = document.getElementById('msg');
    const $scale = document.getElementById('scale');

    // ---------- WebXR Hit-Test ----------
    function initWebXR(){
      const scene = document.querySelector('#mode-webxr a-scene');
      const reticle = document.getElementById('reticle');
      const text = document.getElementById('text-webxr');
      const startBtn = document.getElementById('startAR');

      let hitTestSource = null;

      startBtn.addEventListener('click', async ()=>{
        try{
          const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures:['hit-test','dom-overlay'],
            domOverlay: {root: document.body}
          });
          scene.renderer.xr.setSession(session);

          const viewerSpace = await session.requestReferenceSpace('viewer');
          hitTestSource = await session.requestHitTestSource({space: viewerSpace});
          session.addEventListener('end', ()=>{ hitTestSource=null; reticle.object3D.visible=false; });
        }catch(err){
          console.error(err);
          alert('Failed to start AR session. Try Android Chrome.');
        }
      });

      scene.renderer.xr.setAnimationLoop((t, frame)=>{
        if(!frame || !hitTestSource) return;
        const referenceSpace = scene.renderer.xr.getReferenceSpace();
        const hits = frame.getHitTestResults(hitTestSource);
        if (hits.length){
          const pose = hits[0].getPose(referenceSpace);
          const p = pose.transform.position, q = pose.transform.orientation;
          reticle.object3D.visible = true;
          reticle.object3D.position.set(p.x, p.y, p.z);
          reticle.object3D.quaternion.set(q.x,q.y,q.z,q.w);
          reticle.object3D.rotation.x = -Math.PI/2;
        }else{
          reticle.object3D.visible = false;
        }
      });

      // 点击把文字放到光标处
      scene.addEventListener('click', ()=>{
        if (!reticle.object3D.visible) return;
        const p = reticle.object3D.position;
        text.setAttribute('position', `${p.x} ${p.y+0.01} ${p.z}`);
        text.setAttribute('visible', 'true');
        state.webxr = state.webxr || {};
        state.webxr.pos = [p.x, p.y+0.01, p.z]; persist();
      });

      // 恢复
      if (state.webxr && state.webxr.pos){
        const [x,y,z] = state.webxr.pos;
        text.setAttribute('position', `${x} ${y} ${z}`);
        text.setAttribute('visible', 'true');
        if (state.webxr.msg) text.setAttribute('text', `value: ${state.webxr.msg}; align: center; width: 2; color: #FFD166`);
        if (state.webxr.scale) text.setAttribute('scale', `${state.webxr.scale} ${state.webxr.scale} ${state.webxr.scale}`);
      }

      // 表单
      $form.addEventListener('submit', e=>{
        e.preventDefault();
        const msg = $msg.value || '';
        const sc = parseFloat($scale.value||'1')||1;
        text.setAttribute('text', `value: ${msg}; align: center; width: 2; color: #FFD166; wrapCount: 24`);
        text.setAttribute('scale', `${sc} ${sc} ${sc}`);
        state.webxr = state.webxr || {};
        state.webxr.msg = msg; state.webxr.scale = sc; persist();
      });
    }

    // ---------- AR.js ----------
    function initARJS(){
      const scene = document.querySelector('#mode-arjs a-scene');
      const cursor = document.querySelector('#mouseCursor');

      function findAncestorMarker(el){
        let p = el; while (p && p.tagName){ if (p.tagName.toLowerCase()==='a-marker') return p; p = p.parentEl; } return null;
      }
      function textEntityForMarkerId(mid){
        if (mid==='marker-hiro') return document.getElementById('text-hiro');
        if (mid==='marker-kanji') return document.getElementById('text-kanji');
        return null;
      }
      scene.addEventListener('click', ()=>{
        const rc = cursor.components.raycaster;
        if (!rc || !rc.intersections?.length) return;
        const hit = rc.intersections[0];
        const markerEl = findAncestorMarker(hit.object.el); if (!markerEl) return;
        const local = markerEl.object3D.worldToLocal(hit.point.clone());
        const t = textEntityForMarkerId(markerEl.id); if (!t) return;
        t.setAttribute('position', `${local.x} ${Math.max(local.y,0)} ${local.z}`);
        const key = (markerEl.id==='marker-hiro')?'hiro':'kanji';
        state[key] = state[key]||{}; state[key].pos=[local.x,Math.max(local.y,0),local.z]; persist();
        state.__last = key; persist();
      });

      // 恢复
      ['hiro','kanji'].forEach(key=>{
        const t = document.getElementById(`text-${key}`);
        const s = state[key];
        if (!t || !s) return;
        if (s.pos){ const [x,y,z]=s.pos; t.setAttribute('position', `${x} ${y} ${z}`); }
        if (s.msg){ t.setAttribute('text', `value: ${s.msg}; align: center; width: 1.8; color: ${key==='hiro'?'#90EE90':'#FFD166'}; wrapCount: 24`); }
        if (s.scale){ t.setAttribute('scale', `${s.scale} ${s.scale} ${s.scale}`); }
      });

      // 表单
      $form.addEventListener('submit', e=>{
        e.preventDefault();
        const msg = $msg.value || '';
        const sc = parseFloat($scale.value||'1')||1;
        let key = state.__last || 'hiro';
        const t = document.getElementById(`text-${key}`);
        if (t){
          t.setAttribute('text', `value: ${msg}; align: center; width: 1.8; color: ${key==='hiro'?'#90EE90':'#FFD166'}; wrapCount: 24`);
          t.setAttribute('scale', `${sc} ${sc} ${sc}`);
          state[key] = state[key] || {}; state[key].msg = msg; state[key].scale = sc; persist();
        }
      });
    }
  </script>
</body>
</html>