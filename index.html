<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Shared AR Text â€” Marker + Click + Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- A-Frame + AR.jsï¼ˆç¨³å®šCDNï¼‰ -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.js"></script>

  <!-- Firebaseï¼ˆWeb v9+ CDN æ¨¡å—ï¼‰-->
  <script type="module">
    // é¢„åŠ è½½ï¼ˆé˜²æ­¢åé¢é¦–æ¬¡ import æ—¶é—ªçƒï¼‰
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  </script>

  <style>
    html, body { margin:0; padding:0; height:100dvh; background:transparent; overflow:hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }

    /* çŠ¶æ€æ¡ & ç½‘ç»œæ¡ */
    #scanStatus{
      position:fixed; top:8px; left:8px; z-index:20; background:rgba(0,0,0,.7);
      color:#fff; padding:8px 12px; border-radius:12px; font-size:13px; backdrop-filter:blur(8px);
    }
    #scanStatus.success{ background:rgba(34,197,94,.85); }
    #scanStatus.error{ background:rgba(239,68,68,.85); }
    #net{ position:fixed; top:8px; right:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; }

    /* åº•éƒ¨è¾“å…¥æ¡ */
    #ui{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:rgba(0,0,0,.6); color:#fff; padding:10px 10px calc(12px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.25); backdrop-filter:blur(8px);
    }
    #ui form{ display:grid; grid-template-columns:1fr minmax(70px,110px) auto; gap:8px; align-items:end; }
    #ui label{ display:flex; flex-direction:column; font-size:12px; opacity:.95; }
    #ui input{ height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1); color:#fff; padding:6px 10px; }
    #ui button{ height:36px; border:none; border-radius:10px; background:#4ad; color:#002; font-weight:700; padding:0 16px; }
    #status{ margin-top:6px; font-size:12px; opacity:.85; }

    /* â€”â€”å…³é”®ï¼šDOM è§†é¢‘å½“èƒŒæ™¯ï¼Œç”»å¸ƒåœ¨ä¸Šâ€”â€” */
    #arjs-video, video#arjs-video{
      position:fixed !important; top:0; left:0; width:100vw; height:100vh;
      object-fit:cover; z-index:0; background:#000;
    }
    canvas.a-canvas{ position:fixed !important; top:0; left:0; z-index:1; }

    .a-enter-vr-button, .a-enter-ar-button, .a-orientation-modal{ display:none !important; }
    *{ -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color:transparent; }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨çŠ¶æ€ -->
  <div id="scanStatus">ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanjiâ€¦</div>
  <div id="net">ğŸŸ¢ åœ¨çº¿</div>

  <!-- AR åœºæ™¯ï¼šä½¿ç”¨ DOM è§†é¢‘ï¼ˆvideoTexture:falseï¼‰ -->
  <a-scene id="scene" embedded vr-mode-ui="enabled:false"
           renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true"
           arjs="sourceType:webcam; videoTexture:false; debugUIEnabled:false; trackingMethod:best; maxDetectionRate:60; canvasWidth:640; canvasHeight:480">

    <a-entity light="type:ambient; intensity:0.7"></a-entity>
    <a-entity light="type:directional; intensity:0.8" position="0.5 1 0.5"></a-entity>

    <!-- Markerï¼šæŠŠå¯ç‚¹å‡»åŒºåŸŸæ”¾å¤§ï¼ˆ6x6mï¼‰ï¼Œç”¨äºæ‹¾å–ç‚¹ -->
    <a-marker id="marker-hiro" preset="hiro">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
    </a-marker>
    <a-marker id="marker-kanji" preset="kanji">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
    </a-marker>

    <!-- ç”¨é¼ æ ‡/è§¦æ‘¸å°„çº¿å‘½ä¸­ dropzone -->
    <a-entity id="mouse" cursor="rayOrigin: mouse" raycaster="objects: .dropzone; interval: 0"></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- åº•éƒ¨è¾“å…¥æ ï¼ˆå¤šäººå…±äº«ï¼‰ -->
  <div id="ui">
    <form id="form">
      <label>Text
        <input id="msg" placeholder="è¾“å…¥æ–‡æœ¬â€¦" maxlength="80" />
      </label>
      <label>Scale
        <input id="scale" value="1.0" />
      </label>
      <button type="submit" id="submit">æäº¤ / Pin</button>
    </form>
    <div id="status">æœªé€‰ä½ç½®</div>
  </div>

  <script type="module">
    /********* çŠ¶æ€/DOM *********/
    const $scan = document.getElementById('scanStatus');
    const $net  = document.getElementById('net');
    const scene = document.getElementById('scene');
    const mouse = document.getElementById('mouse');
    const $form = document.getElementById('form');
    const $msg  = document.getElementById('msg');
    const $scale= document.getElementById('scale');
    const $stat = document.getElementById('status');
    const $btn  = document.getElementById('submit');

    function setScan(text, cls){ $scan.className=''; if(cls) $scan.classList.add(cls); $scan.textContent = text; }
    function setNet(online){ $net.textContent = online ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿'; }
    setNet(navigator.onLine);
    addEventListener('online',  ()=>setNet(true));
    addEventListener('offline', ()=>setNet(false));

    /********* è¯†åˆ«çŠ¶æ€ *********/
    const found = new Set();
    const hiro  = document.getElementById('marker-hiro');
    const kanji = document.getElementById('marker-kanji');
    const vibrate = (n=20)=>{ try{ navigator.vibrate && navigator.vibrate(n);}catch{} };

    const onFound = name => { found.add(name); setScan(`âœ… å·²è¯†åˆ« ${name}ï¼Œå¯ç‚¹é€‰æ”¾ç½®`, 'success'); vibrate(20); };
    const onLost  = () => { if(found.size===0) setScan('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanjiâ€¦'); };

    hiro.addEventListener('markerFound', ()=>onFound('Hiro'));
    kanji.addEventListener('markerFound', ()=>onFound('Kanji'));
    hiro.addEventListener('markerLost',  ()=>{found.delete('Hiro'); onLost();});
    kanji.addEventListener('markerLost', ()=>{found.delete('Kanji'); onLost();});

    /********* é€‰ç‚¹é¢„è§ˆ *********/
    const USER_ID = 'user_' + Math.random().toString(36).slice(2,8);
    let CURRENT = { anchor:null, pos:null };

    function findMarker(el){ let p=el; while(p && p.tagName){ if(p.tagName.toLowerCase()==='a-marker') return p; p=p.parentEl; } return null; }
    const round2 = n => Math.round(n*100)/100;
    const norm = (x,y,z)=>[round2(x), Math.max(round2(y),0)+0.001, round2(z)];

    function showPreview(anchor, pos, ok=false){
      const parent = document.getElementById(`marker-${anchor}`);
      if(!parent) return;
      // ring cursor
      let cur = document.getElementById(`cursor-${anchor}`);
      if(!cur){ cur = document.createElement('a-entity'); cur.id=`cursor-${anchor}`; parent.appendChild(cur); }
      if(ok){ cur.setAttribute('geometry','primitive:ring; radiusInner:0.015; radiusOuter:0.025');
              cur.setAttribute('material','color:#00FF00; opacity:1'); }
      else  { cur.setAttribute('geometry','primitive:ring; radiusInner:0.012; radiusOuter:0.02');
              cur.setAttribute('material','color:#FFD166; opacity:.95'); }
      cur.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);

      // translucent text preview
      let prev = document.getElementById(`preview-${anchor}`);
      if(!prev){ prev = document.createElement('a-entity'); prev.id=`preview-${anchor}`; parent.appendChild(prev); }
      const msg = $msg.value || '';
      const base = anchor==='hiro' ? '#90EE90' : '#FFD166';
      const color= ok ? '#00FF00' : base;
      const sc = parseFloat($scale.value||'1')||1;
      prev.setAttribute('text', `value:${ok?'âœ“ ':''}${msg}; align:center; width:1.8; color:${color}; wrapCount:24`);
      prev.setAttribute('material','opacity:.75; transparent:true');
      prev.setAttribute('scale', `${sc} ${sc} ${sc}`);
      prev.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);
    }

    scene.addEventListener('click', ()=>{
      const rc = mouse.components.raycaster;
      if(!rc || !rc.intersections?.length) return;
      const hit = rc.intersections[0];
      if(!hit.object?.el?.classList?.contains('dropzone')) return;
      const marker = findMarker(hit.object.el); if(!marker) return;
      const local = marker.object3D.worldToLocal(hit.point.clone());
      const anchor = (marker.id==='marker-hiro')?'hiro':'kanji';
      const pos = norm(local.x, local.y, local.z);
      CURRENT = { anchor, pos };
      $stat.textContent = `å·²é€‰ï¼š${anchor} (${pos.map(n=>n.toFixed(2)).join(', ')})`;
      showPreview(anchor, pos);
    });

    /********* Firebase *********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYsPxSPvpv8mPQdVGJuzE2TKZ0qY6e608",
      authDomain: "ar-maker-share.firebaseapp.com",
      projectId: "ar-maker-share",
      storageBucket: "ar-maker-share.appspot.com",
      messagingSenderId: "68968164615",
      appId: "1:68968164615:web:c56d3c17046ff51ebf29a2"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const pins = collection(db, "pins");

    // æ¸²æŸ“ Firestore pins
    const q = query(pins, orderBy('ts','asc'));
    onSnapshot(q, (snap)=>{
      snap.docChanges().forEach(ch=>{
        const d = ch.doc.data();
        if(d.mode!=='arjs') return;
        const anchor = (d.anchor==='kanji')?'kanji':'hiro';
        const parent = document.getElementById(`marker-${anchor}`); if(!parent) return;

        if(ch.type==='removed'){ const old=document.getElementById(`pin-${ch.doc.id}`); if(old) old.remove(); return; }
        let el = document.getElementById(`pin-${ch.doc.id}`);
        if(!el){ el=document.createElement('a-entity'); el.id=`pin-${ch.doc.id}`; parent.appendChild(el); }
        const [x,y,z] = d.pos || [0,0,0];
        el.setAttribute('position', `${x} ${y} ${z}`);

        if(d.modelUrl){ // æœªæ¥å¦‚è¿”å›æ¨¡å‹
          el.removeAttribute('text');
          const s=d.scale||1; el.setAttribute('gltf-model', d.modelUrl); el.setAttribute('scale', `${s} ${s} ${s}`);
        }else{          // æ–‡æœ¬
          const mine = d.userId===USER_ID;
          const base = anchor==='hiro' ? '#90EE90' : '#FFD166';
          const color= mine ? base : '#ccc';
          const s=d.scale||1;
          el.setAttribute('text', `value:${d.text||''}; align:center; width:1.8; color:${color}; wrapCount:24`);
          el.setAttribute('scale', `${s} ${s} ${s}`);
        }
      });
    });

    // æäº¤åˆ° Firestore
    async function savePin({anchor,pos,text,scale}){
      return await addDoc(pins, {
        mode:'arjs', anchor, pos, text, scale, userId: USER_ID, ts: serverTimestamp()
      });
    }

    // è¡¨å•æäº¤
    $form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = ($msg.value||'').trim();
      const sc  = parseFloat($scale.value||'1')||1;
      if(!msg) return alert('è¯·è¾“å…¥æ–‡æœ¬');
      if(!CURRENT.pos) return alert('è¯·å…ˆåœ¨æ ‡è®°é™„è¿‘ç‚¹å‡»é€‰æ‹©ä½ç½®');
      if(!navigator.onLine) return alert('ç¦»çº¿çŠ¶æ€ï¼Œæ— æ³•æäº¤');

      const {anchor,pos} = CURRENT;
      try{
        $btn.disabled = true;
        showPreview(anchor,pos,true); setScan('â³ æ­£åœ¨æäº¤â€¦','');
        await savePin({anchor,pos,text:msg,scale:sc});
        setScan('âœ… å·²æäº¤ï¼Œå…¶ä»–äººä¹Ÿèƒ½çœ‹åˆ°','success');
        $msg.value='';
        setTimeout(()=>{ ['preview-','cursor-'].forEach(p=>{ const el=document.getElementById(p+anchor); if(el) el.remove(); }); $stat.textContent='å°±ç»ª'; }, 2000);
        CURRENT = { anchor:null, pos:null };
      }catch(err){
        console.error(err); setScan('âŒ æäº¤å¤±è´¥','error'); showPreview(anchor,pos,false);
      }finally{
        setTimeout(()=>{ $btn.disabled=false; onLost(); }, 1000);
      }
    });
  </script>
</body>
</html>
