<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Shared AR Text â€” Marker + Click + Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.js"></script>

  <!-- é¢„åŠ è½½ Firebase æ¨¡å— -->
  <script type="module">
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  </script>

  <style>
    html, body { 
      margin:0; padding:0; height:100dvh; background:#000; overflow:hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; 
    }

    #scanStatus{
      position:fixed; top:8px; left:8px; z-index:20; background:rgba(0,0,0,.75);
      color:#fff; padding:8px 12px; border-radius:12px; font-size:13px; backdrop-filter:blur(8px);
      transition: all 0.3s ease;
    }
    #scanStatus.success{ background:rgba(34,197,94,.9); }
    #scanStatus.error{ background:rgba(239,68,68,.9); }
    
    #net{ 
      position:fixed; top:8px; right:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; 
    }
    
    #debug{
      position:fixed; top:50px; left:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:11px; max-width:280px; line-height:1.35;
      white-space:pre-wrap; max-height:150px; overflow-y:auto;
    }

    #ui{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:rgba(0,0,0,.8); color:#fff; padding:12px 12px calc(16px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.4); backdrop-filter:blur(12px);
      display:none; border-radius: 16px 16px 0 0;
    }
    #ui form{ display:grid; grid-template-columns:1fr 80px auto; gap:10px; align-items:end; }
    #ui label{ display:flex; flex-direction:column; font-size:12px; opacity:.9; gap:4px; }
    #ui input{ height:40px; border-radius:12px; border:1px solid rgba(255,255,255,.3);
      background:rgba(255,255,255,.15); color:#fff; padding:8px 12px; font-size:14px; transition: all 0.2s ease; }
    #ui input:focus { outline:none; border-color:rgba(77,171,221,.8); background:rgba(255,255,255,.25); }
    #ui button{ height:40px; border:none; border-radius:12px; background:#4ad; color:#002; 
      font-weight:700; padding:0 18px; font-size:14px; transition: all 0.2s ease; cursor: pointer; }
    #ui button:hover:not(:disabled) { background:#3bc; transform: translateY(-1px); }
    #ui button:disabled { opacity:0.6; cursor: not-allowed; }
    #status{ margin-top:8px; font-size:12px; opacity:.85; padding:6px 0; }

    /* ç›¸æœºè§†é¢‘åœ¨åº•ï¼ŒWebGL ç”»å¸ƒåœ¨ä¸Š */
    video, #arjs-video, video#arjs-video{
      position:fixed !important; top:0 !important; left:0 !important;
      width:100vw !important; height:100vh !important; object-fit:cover !important;
      z-index:0 !important; background:#000 !important; display:block !important; visibility:visible !important; opacity:1 !important;
    }
    canvas.a-canvas{ position:fixed !important; top:0 !important; left:0 !important; z-index:1 !important; background:transparent !important; }

    .a-enter-vr-button, .a-enter-ar-button, .a-orientation-modal{ display:none !important; }
    *{ -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color:transparent; }

    /* å¼€å§‹æŒ‰é’® */
    #startAR {
      position: fixed; left: 16px; right: 16px; bottom: 16px; z-index: 30;
      height: 52px; border: none; border-radius: 16px; background: linear-gradient(45deg, #4ad, #3bc);
      color: #002; font-weight: 800; font-size: 17px; box-shadow: 0 8px 32px rgba(0,0,0,.4); cursor: pointer;
      transition: all 0.3s ease;
    }
    #startAR:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,.5); }
  </style>
</head>
<body>
  <div id="scanStatus">ğŸ‘‹ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ AR</div>
  <div id="net">ğŸŸ¢ åœ¨çº¿</div>
  <div id="debug">ç­‰å¾…å¯åŠ¨â€¦</div>

  <button id="startAR">ğŸš€ å¼€å§‹ AR ä½“éªŒ</button>

  <a-scene id="scene" style="display:none"
           embedded vr-mode-ui="enabled:false"
           renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true; sortObjects:true;">
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0.5 1 0.5"></a-entity>

    <!-- Hiro Marker -->
    <a-marker id="marker-hiro" preset="hiro" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
      <!-- å°å·ä¸­å¿ƒæŒ‡ç¤ºæŸ±ï¼ˆæ›´å°æ›´ä¸æŒ¡è§†çº¿ï¼‰ -->
      <a-box id="indicator-hiro" position="0 0.10 0" width="0.10" height="0.18" depth="0.10"
             material="color:#19d47d; opacity:0.9"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear"></a-box>
    </a-marker>

    <!-- Kanji Marker -->
    <a-marker id="marker-kanji" preset="kanji" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
      <a-box id="indicator-kanji" position="0 0.10 0" width="0.10" height="0.18" depth="0.10"
             material="color:#ffd166; opacity:0.9"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear"></a-box>
    </a-marker>

    <!-- å…‰çº¿æ‹¾å– -->
    <a-entity id="mouse" cursor="rayOrigin: mouse" raycaster="objects: .dropzone; interval: 0"></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="ui">
    <form id="form">
      <label>ğŸ“ æ–‡æœ¬å†…å®¹
        <input id="msg" placeholder="è¾“å…¥ä½ è¦æ”¾ç½®çš„æ–‡å­—..." maxlength="80" />
      </label>
      <label>ğŸ“ å¤§å°
        <input id="scale" type="number" step="0.1" value="1.0" min="0.1" max="5" inputmode="decimal" />
      </label>
      <button type="submit" id="submit">âœ¨ æ”¾ç½®</button>
    </form>
    <div id="status">ğŸ’¡ å…ˆåœ¨æ ‡è®°å†…ç‚¹å‡»é€‰æ‹©ä½ç½®</div>
  </div>

  <script type="module">
    /******** å¯è°ƒå‚æ•° ********/
    const PREVIEW_DEFAULT_TEXT = 'Hello AR!';     // æœªè¾“å…¥æ—¶çš„å ä½é¢„è§ˆ
    const USE_INDICATOR = true;                   // æ˜¾ç¤ºå°å·æ–œæŸ±
    const INDICATOR_MODE = 'center';              // 'center' | 'follow'
    const INDICATOR_HEIGHT_OFFSET = 0.10;         // æ–œæŸ±ç¦»å¹³é¢çš„é«˜åº¦ï¼ˆç•¥è°ƒå°ï¼‰

    /******** DOM & çŠ¶æ€ ********/
    const $scan = document.getElementById('scanStatus');
    const $net  = document.getElementById('net');
    const $debug= document.getElementById('debug');
    const scene = document.getElementById('scene');
    const mouse = document.getElementById('mouse');
    const $form = document.getElementById('form');
    const $msg  = document.getElementById('msg');
    const $scale= document.getElementById('scale');
    const $stat = document.getElementById('status');
    const $btn  = document.getElementById('submit');
    const $start= document.getElementById('startAR');

    const setNet  = on => $net.textContent = on ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
    const setDebug= txt => $debug.textContent = txt;
    setNet(navigator.onLine); 
    addEventListener('online',()=>setNet(true)); 
    addEventListener('offline',()=>setNet(false));

    const vibrate = (pattern=20)=>{ try{ navigator.vibrate && navigator.vibrate(pattern);}catch{} };

    // æ‰«ææç¤ºï¼ˆèŠ‚æµï¼‰
    let _scanTimer=null, _scanCache='';
    function setScan(txt, cls=''){
      if (txt===_scanCache) return;
      clearTimeout(_scanTimer);
      _scanTimer = setTimeout(()=>{
        _scanCache = txt;
        $scan.className = cls;
        $scan.textContent = txt;
      }, 50);
    }

    /******** å¯åŠ¨ ARï¼ˆå…ˆç”³è¯·ç›¸æœºæƒé™ï¼Œé‡Šæ”¾ï¼Œå†äº¤ç»™ AR.jsï¼‰ ********/
    const ARJS_ATTR = `
      sourceType: webcam;
      videoTexture: false;
      detectionMode: mono;
      sourceWidth: 1280;
      sourceHeight: 720;
      maxDetectionRate: 60;
      debugUIEnabled: false;
      patternRatio: 0.8
    `;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);

    function forceVideoVisible(){
      const videos = document.querySelectorAll('video');
      videos.forEach(v=>{
        v.setAttribute('playsinline','true'); v.setAttribute('webkit-playsinline','true'); v.muted = true;
        v.style.display='block'; v.style.visibility='visible'; v.style.opacity='1'; v.style.zIndex='0';
      });
      const canvas = document.querySelector('.a-canvas'); 
      if(canvas){ canvas.style.zIndex='1'; canvas.style.background='transparent'; }
    }

    $start.addEventListener('click', async () => {
      try {
        setScan('ğŸ“· æ­£åœ¨è¯·æ±‚ç›¸æœºæƒé™...');
        const stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }
        });
        stream.getTracks().forEach(t=>t.stop());
        await new Promise(r=>setTimeout(r,300));

        scene.setAttribute('arjs', ARJS_ATTR);
        scene.style.display = 'block';
        $start.style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        setScan('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanji æ ‡è®°...');

        setTimeout(forceVideoVisible, 600);
        if (isIOS || isAndroid) [1000,2000,3000,5000].forEach(t=>setTimeout(forceVideoVisible, t));
        vibrate([100,50,100]);
      } catch (e) {
        console.error('Camera access error:', e);
        setScan('âŒ éœ€è¦æ‘„åƒå¤´æƒé™æ‰èƒ½ä½¿ç”¨ AR', 'error');
        alert('éœ€è¦ç›¸æœºæƒé™æ‰èƒ½ä½¿ç”¨ AR åŠŸèƒ½ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®æ‘„åƒå¤´ã€‚');
      }
    });

    /******** è¯†åˆ«çŠ¶æ€ç®¡ç†ï¼ˆäº‹ä»¶ + è½®è¯¢ï¼‰ ********/
    const markerState = {
      hiro:  { detected:false, lastSeen:0, consecutiveVisible:0, lastClickPos:null },
      kanji: { detected:false, lastSeen:0, consecutiveVisible:0, lastClickPos:null }
    };
    const hiro  = document.getElementById('marker-hiro');
    const kanji = document.getElementById('marker-kanji');

    const updateScanStatus = () => {
      const active = Object.entries(markerState).filter(([_,s])=>s.detected).map(([n])=>n[0].toUpperCase()+n.slice(1));
      if (active.length>0) setScan(`âœ… å·²è¯†åˆ« ${active.join(' / ')} æ ‡è®°ï¼Œç‚¹å‡»æ ‡è®°è¡¨é¢é€‰æ‹©ä½ç½®`, 'success');
      else setScan('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanji æ ‡è®°...');
    };

    function onMarkerFound(name){
      const key = name.toLowerCase(); const s = markerState[key];
      if (!s.detected){ s.detected=true; vibrate(15); setScan(`âœ… å·²è¯†åˆ« ${name} æ ‡è®°ï¼Œè¯·åœ¨æ ‡è®°å†…è½»ç‚¹é€‰æ‹©ä½ç½®`, 'success'); }
      s.lastSeen = Date.now(); s.consecutiveVisible++; updateScanStatus();
    }
    function onMarkerLost(name){
      const key = name.toLowerCase(); const s = markerState[key];
      if (s.detected){ s.detected=false; s.consecutiveVisible=0; updateScanStatus(); }
    }
    hiro.addEventListener('markerFound', ()=>onMarkerFound('Hiro'));
    kanji.addEventListener('markerFound', ()=>onMarkerFound('Kanji'));
    hiro.addEventListener('markerLost',  ()=>onMarkerLost('Hiro'));
    kanji.addEventListener('markerLost',  ()=>onMarkerLost('Kanji'));

    // è½®è¯¢å¢å¼º
    let pollCount=0; const DETECTION_THRESHOLD=3, LOSS_TIMEOUT=1500;
    setInterval(()=>{
      pollCount++;
      const now=Date.now();
      const vis={ hiro:!!(hiro.object3D&&hiro.object3D.visible), kanji:!!(kanji.object3D&&kanji.object3D.visible) };
      ['hiro','kanji'].forEach(name=>{
        const s=markerState[name]; const cap=name[0].toUpperCase()+name.slice(1);
        if (vis[name]){ s.lastSeen=now; s.consecutiveVisible++; if(!s.detected && s.consecutiveVisible>=DETECTION_THRESHOLD) onMarkerFound(cap); }
        else{ s.consecutiveVisible=0; if(s.detected && now-s.lastSeen>LOSS_TIMEOUT) onMarkerLost(cap); }
      });
      setDebug(`è½®è¯¢:${pollCount}
Hiro: ${vis.hiro?'âœ…å¯è§':'âŒéšè—'} (è¿${markerState.hiro.consecutiveVisible}) ${markerState.hiro.detected?'å·²è¯†åˆ«':'æœªè¯†åˆ«'}
Kanji:${vis.kanji?'âœ…å¯è§':'âŒéšè—'} (è¿${markerState.kanji.consecutiveVisible}) ${markerState.kanji.detected?'å·²è¯†åˆ«':'æœªè¯†åˆ«'}`);
    },150);

    /******** é¢„è§ˆï¼ˆåœ†ç¯ + æ–‡æœ¬ï¼‰ & å°å·æ–œæŸ± ********/
    const USER_ID = 'user_' + Math.random().toString(36).slice(2,10);
    let CURRENT_SELECTION = { anchor:null, pos:null };

    const findMarkerElement = el => { let p=el; while(p&&p.tagName){ if(p.tagName.toLowerCase()==='a-marker') return p; p=p.parentEl; } return null; };
    const round2 = n => Math.round(n*100)/100;
    const normalizePosition = (x,y,z)=>[round2(x), Math.max(round2(y),0)+0.001, round2(z)];
    const getPreviewText = ()=> ($msg.value.trim() || PREVIEW_DEFAULT_TEXT);

    function ensureIndicatorPosition(anchor){
      if (!USE_INDICATOR) return;
      const box=document.getElementById(`indicator-${anchor}`);
      if (!box) return;
      if (INDICATOR_MODE==='center'){
        box.setAttribute('position', `0 ${INDICATOR_HEIGHT_OFFSET} 0`);
      }
    }

    function showPreview(anchor, pos, confirmed=false){
      const parent=document.getElementById(`marker-${anchor}`); if(!parent) return;

      // åœ†ç¯
      let ring=document.getElementById(`cursor-${anchor}`);
      if(!ring){ ring=document.createElement('a-entity'); ring.id=`cursor-${anchor}`; parent.appendChild(ring); }
      ring.setAttribute('rotation','-90 0 0');
      ring.setAttribute('geometry', confirmed? 'primitive:ring; radiusInner:0.018; radiusOuter:0.028' : 'primitive:ring; radiusInner:0.012; radiusOuter:0.022');
      ring.setAttribute('material', confirmed? 'color:#00FF00; opacity:1' : 'color:#FFD166; opacity:0.9');
      if (confirmed) ring.setAttribute('animation','property: scale; to:1.2 1.2 1.2; direction:alternate; loop:true; dur:800');
      else ring.removeAttribute('animation');
      ring.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);

      // é¢„è§ˆæ–‡æœ¬
      let txt=document.getElementById(`preview-${anchor}`);
      if(!txt){ txt=document.createElement('a-entity'); txt.id=`preview-${anchor}`; parent.appendChild(txt); }
      const base = anchor==='hiro' ? '#90EE90' : '#FFD166';
      const color= confirmed ? '#00FF00' : base;
      const s = parseFloat($scale.value||'1')||1;
      txt.setAttribute('rotation','-90 0 0');
      txt.setAttribute('text', `value:${confirmed?'âœ“ ':''}${getPreviewText()}; align:center; width:1.8; color:${color}; wrapCount:24`);
      txt.setAttribute('material','opacity:0.9; transparent:true');
      txt.setAttribute('scale', `${s} ${s} ${s}`);
      txt.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);

      // æ–œæŸ±è·Ÿéš
      if (USE_INDICATOR && INDICATOR_MODE==='follow'){
        const ind=document.getElementById(`indicator-${anchor}`);
        if (ind) ind.setAttribute('position', `${pos[0]} ${pos[1]+INDICATOR_HEIGHT_OFFSET} ${pos[2]}`);
      }
    }

    // ç‚¹å‡»æ‹¾å–
    scene.addEventListener('click', ()=>{
      const rc = mouse.components.raycaster;
      if(!rc || !rc.intersections?.length) return;
      const hit = rc.intersections[0];
      if(!hit.object?.el?.classList?.contains('dropzone')) return;

      const markerEl = findMarkerElement(hit.object.el); if(!markerEl) return;
      if (!markerEl.object3D?.visible){
        setScan('âš ï¸ æ ‡è®°æœªè¢«ç¨³å®šè¯†åˆ«ï¼Œè¯·ç¡®ä¿æ•´å¼ æ ‡è®°åœ¨å–æ™¯æ¡†å†…', 'error');
        setTimeout(updateScanStatus, 1200);
        return;
      }

      const anchor = markerEl.id==='marker-hiro' ? 'hiro' : 'kanji';
      const local = markerEl.object3D.worldToLocal(hit.point.clone());
      const pos = normalizePosition(local.x, local.y, local.z);

      markerState[anchor].lastClickPos = pos;
      CURRENT_SELECTION = { anchor, pos };
      $stat.textContent = `ğŸ“ å·²é€‰ä½ç½®ï¼š${anchor.toUpperCase()} (${pos.map(n=>n.toFixed(2)).join(', ')})`;
      setScan('âœ… ä½ç½®å·²é€‰ä¸­ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ–‡å­—å†…å®¹', 'success');
      showPreview(anchor, pos);
      vibrate(30);
    });

    // è¾“å…¥ä¸ç¼©æ”¾æ—¶å®æ—¶é¢„è§ˆ
    $msg.addEventListener('input', ()=>{ if(CURRENT_SELECTION.anchor) showPreview(CURRENT_SELECTION.anchor, CURRENT_SELECTION.pos); });
    $scale.addEventListener('input', ()=>{ if(CURRENT_SELECTION.anchor) showPreview(CURRENT_SELECTION.anchor, CURRENT_SELECTION.pos); });

    // æ ‡è®°å‡ºç°æ—¶ï¼Œå®‰æ”¾ä¸­å¿ƒæ–œæŸ±
    ['hiro','kanji'].forEach(a=>{
      document.getElementById(`marker-${a}`).addEventListener('markerFound', ()=>ensureIndicatorPosition(a));
    });

    /******** Firebase å®æ—¶åŒæ­¥ ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYsPxSPvpv8mPQdVGJuzE2TKZ0qY6e608",
      authDomain: "ar-maker-share.firebaseapp.com",
      projectId: "ar-maker-share",
      storageBucket: "ar-maker-share.appspot.com",
      messagingSenderId: "68968164615",
      appId: "1:68968164615:web:c56d3c17046ff51ebf29a2"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const pinsCollection = collection(db, "pins");

    // ç›‘å¬äº‘ç«¯ pin
    const pinsQuery = query(pinsCollection, orderBy('ts','asc'));
    onSnapshot(pinsQuery, (snapshot)=>{
      snapshot.docChanges().forEach(change=>{
        const d = change.doc.data();
        if (d.mode !== 'arjs') return;

        const anchor = d.anchor === 'kanji' ? 'kanji' : 'hiro';
        const parent = document.getElementById(`marker-${anchor}`); 
        if (!parent) return;

        if (change.type === 'removed'){
          const old = document.getElementById(`pin-${change.doc.id}`); 
          if (old) old.remove(); 
          return;
        }

        let el = document.getElementById(`pin-${change.doc.id}`);
        if (!el){ el = document.createElement('a-entity'); el.id=`pin-${change.doc.id}`; parent.appendChild(el); }

        const [x,y,z] = d.pos || [0,0,0];
        el.setAttribute('position', `${x} ${y} ${z}`);

        if (d.modelUrl){
          el.removeAttribute('text');
          const s = d.scale || 1;
          el.setAttribute('gltf-model', d.modelUrl);
          el.setAttribute('scale', `${s} ${s} ${s}`);
        } else {
          const mine  = d.userId === USER_ID;
          const base  = anchor==='hiro' ? '#90EE90' : '#FFD166';
          const color = mine ? base : '#ccc';
          const s     = d.scale || 1;

          el.setAttribute('rotation', '-90 0 0');  // è®©æ–‡æœ¬è´´åœ¨å¹³é¢
          el.setAttribute('text', `value:${d.text||''}; align:center; width:1.8; color:${color}; wrapCount:24`);
          el.setAttribute('scale', `${s} ${s} ${s}`);
        }
      });
    });

    async function savePin({anchor,pos,text,scale}){
      return await addDoc(pinsCollection, {
        mode:'arjs', anchor, pos, text, scale, userId: USER_ID, ts: serverTimestamp()
      });
    }

    $form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = ($msg.value||'').trim();
      const sc  = parseFloat($scale.value||'1')||1;
      if(!msg) return alert('è¯·è¾“å…¥æ–‡æœ¬');
      if(!CURRENT_SELECTION.pos) return alert('è¯·å…ˆåœ¨æ ‡è®°å†…ç‚¹å‡»é€‰æ‹©ä½ç½®');
      if(!navigator.onLine) return alert('å½“å‰ç¦»çº¿ï¼Œæ— æ³•æäº¤');

      const {anchor,pos} = CURRENT_SELECTION;
      try{
        $btn.disabled = true;
        showPreview(anchor,pos,true);
        setScan('â³ æ­£åœ¨æäº¤â€¦');
        await savePin({anchor,pos,text:msg,scale:sc});
        setScan('âœ… å·²æäº¤ï¼Œå…¶ä»–äººä¹Ÿèƒ½çœ‹åˆ°','success');
        $msg.value='';
        vibrate(40);
        setTimeout(()=>{
          ['preview-','cursor-'].forEach(p=>{ const el=document.getElementById(p+anchor); if(el) el.remove(); });
          $stat.textContent='å°±ç»ª';
        }, 1600);
        CURRENT_SELECTION = { anchor:null, pos:null };
      }catch(err){
        console.error(err);
        setScan('âŒ æäº¤å¤±è´¥','error');
        if (CURRENT_SELECTION.anchor && CURRENT_SELECTION.pos){
          showPreview(CURRENT_SELECTION.anchor, CURRENT_SELECTION.pos, false);
        }
      }finally{
        setTimeout(()=>{ $btn.disabled=false; updateScanStatus(); }, 800);
      }
    });

    // å›å‰å°æ—¶è¡¥ä¸€æ¬¡å¯è§æ€§ä¿®å¤
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(forceVideoVisible, 400); });
  </script>
</body>
</html>
