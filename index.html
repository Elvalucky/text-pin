<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>Shared AR Text (Marker + Preview + Firebase)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.3/aframe/build/aframe-ar.js"></script>

  <style>
    :root { --ui-bg: rgba(0,0,0,.6); }
    html, body { margin:0; height:100dvh; background:#000; overflow:hidden; }
    #hint{
      position:fixed; top:8px; left:8px; z-index:10;
      background:rgba(0,0,0,.55); color:#fff; padding:8px 10px;
      border-radius:10px; font:13px system-ui;
    }
    /* 网络状态指示器 */
    #network-status {
      position:fixed; top:8px; right:8px; z-index:10;
      background:rgba(0,200,0,.7); color:white; padding:4px 8px;
      border-radius:6px; font:12px system-ui; transition: all 0.3s;
    }
    #network-status.offline { background:rgba(200,0,0,.7); }
    #ui{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:var(--ui-bg); color:#fff;
      font:14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      padding:10px 10px calc(12px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.25); backdrop-filter: blur(6px);
    }
    #ui form{ display:grid; grid-template-columns:1fr minmax(70px,110px) auto; gap:8px; align-items:end; }
    #ui label{ display:flex; flex-direction:column; font-size:12px; opacity:.95; }
    #ui input{
      height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1); color:#fff; padding:6px 10px;
    }
    #ui button{ height:36px; border:none; border-radius:10px; background:#4ad; font-weight:700;
      padding:0 16px; color:#002; cursor:pointer; transition: opacity 0.3s; }
    #ui button:disabled{ opacity:0.5; cursor:not-allowed; }
    #status{ margin-top:6px; font-size:12px; opacity:.85; }
  </style>
</head>
<body>
  <div id="hint">对准 <b>Hiro</b> 或 <b>Kanji</b> 标记 → 点击标记周围出现预览光标 → 在下方输入文字后提交（多人共享）。</div>
  <div id="network-status">🟢 在线</div>

  <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled:false"
           renderer="colorManagement:true; physicallyCorrectLights:true">
    <a-entity light="type: ambient; intensity: 0.7"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0.5 1 0.5"></a-entity>

    <!-- Hiro marker（放大可点区域到 6×6 米） -->
    <a-marker id="marker-hiro" preset="hiro">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0"
               material="opacity:0; transparent:true; side: double"></a-plane>
      <!-- 动态创建：preview-hiro / cursor-hiro / pin-<docid> -->
    </a-marker>

    <!-- Kanji marker -->
    <a-marker id="marker-kanji" preset="kanji">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0"
               material="opacity:0; transparent:true; side: double"></a-plane>
    </a-marker>

    <!-- 鼠标/触摸射线（命中 .dropzone） -->
    <a-entity id="mouse" cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects: .dropzone; interval: 0"></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <!-- 底部输入栏 -->
  <div id="ui">
    <form id="form">
      <label>Text
        <input id="msg" placeholder="输入文本…" maxlength="80" />
      </label>
      <label>Scale
        <input id="scale" value="1.0" />
      </label>
      <button type="submit" id="submit-btn">提交 / Pin</button>
    </form>
    <div id="status">未选位置</div>
  </div>

  <script type="module">
    /******** 当前选点与工具（上移到最前，避免未定义） ********/
    let CURRENT = { anchor:null, pos:null };
    const USER_ID = 'user_' + Math.random().toString(36).slice(2, 8);

    function normalizeCoordinates(x, y, z) {
      return [
        Math.round(x * 100) / 100,
        Math.max(Math.round(y * 100) / 100, 0) + 0.001,
        Math.round(z * 100) / 100
      ];
    }
    function findAncestorMarker(el){
      let p = el;
      while (p && p.tagName){
        if (p.tagName.toLowerCase()==='a-marker') return p;
        p = p.parentEl;
      }
      return null;
    }

    /******** 布局：让画面避开底部 UI ********/
    const uiBar = document.getElementById('ui');
    const sceneEl = document.querySelector('a-scene');
    function layout(){ sceneEl.style.marginBottom = (uiBar.offsetHeight||80) + 'px'; }
    addEventListener('load', layout); addEventListener('resize', layout);
    ['focus','blur','input'].forEach(ev => uiBar.addEventListener(ev, layout, true));

    /******** DOM ********/
    const scene = document.querySelector('a-scene');
    const mouse = document.getElementById('mouse');
    const $form = document.getElementById('form');
    const $msg = document.getElementById('msg');
    const $scale = document.getElementById('scale');
    const $status = document.getElementById('status');
    const $submitBtn = document.getElementById('submit-btn');
    const $networkStatus = document.getElementById('network-status');

    /******** 网络状态检测（防御式访问 CURRENT） ********/
    let isOnline = navigator.onLine;
    function updateNetworkStatus() {
      if (isOnline) {
        $networkStatus.textContent = '🟢 在线';
        $networkStatus.classList.remove('offline');
        $submitBtn.disabled = false;
      } else {
        $networkStatus.textContent = '🔴 离线';
        $networkStatus.classList.add('offline');
        $submitBtn.disabled = true;
        if (!CURRENT || !CURRENT.pos) $status.textContent = '网络离线 - 无法提交';
      }
    }
    window.addEventListener('online', () => {
      isOnline = true; updateNetworkStatus();
      if (CURRENT && CURRENT.pos) $status.textContent = `已选位置：${CURRENT.anchor} - 网络已恢复`;
    });
    window.addEventListener('offline', () => { isOnline = false; updateNetworkStatus(); });
    updateNetworkStatus();

    /******** 防抖 ********/
    function debounce(func, delay) {
      let timeoutId;
      return (...args) => { clearTimeout(timeoutId); timeoutId = setTimeout(() => func(...args), delay); };
    }

    /******** 预览光标 + 半透明文字 ********/
    function showPreview(anchor, pos, isConfirmed = false){
      const parent = document.getElementById(`marker-${anchor}`);
      if (!parent) return;

      let cursor3d = document.getElementById(`cursor-${anchor}`);
      if (!cursor3d){
        cursor3d = document.createElement('a-entity');
        cursor3d.id = `cursor-${anchor}`;
        parent.appendChild(cursor3d);
      }
      if (isConfirmed) {
        cursor3d.setAttribute('geometry', 'primitive: ring; radiusInner: 0.015; radiusOuter: 0.025');
        cursor3d.setAttribute('material', 'color: #00FF00; opacity: 1.0');
        cursor3d.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 2000');
      } else {
        cursor3d.setAttribute('geometry', 'primitive: ring; radiusInner: 0.012; radiusOuter: 0.02');
        cursor3d.setAttribute('material', 'color: #FFD166; opacity: 0.95');
        cursor3d.removeAttribute('animation');
      }
      cursor3d.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);

      let prev = document.getElementById(`preview-${anchor}`);
      if (!prev){
        prev = document.createElement('a-entity');
        prev.id = `preview-${anchor}`;
        parent.appendChild(prev);
      }
      const msg = $msg.value || '';
      const baseColor = anchor === 'hiro' ? '#90EE90' : '#FFD166';
      const color = isConfirmed ? '#00FF00' : baseColor;
      const opacity = isConfirmed ? '1.0' : '0.7';
      const prefix = isConfirmed ? '✓ ' : '';
      const sc = parseFloat($scale.value||'1')||1;

      prev.setAttribute('text', `value: ${prefix}${msg}; align: center; width: 1.8; color: ${color}; wrapCount: 24`);
      prev.setAttribute('material', `opacity: ${opacity}; transparent: true`);
      prev.setAttribute('scale', `${sc} ${sc} ${sc}`);
      prev.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);
    }

    /******** 点击取点 ********/
    scene.addEventListener('click', () => {
      const rc = mouse.components.raycaster;
      if (!rc || !rc.intersections?.length) return;
      const hit = rc.intersections[0];
      if (!hit.object?.el?.classList?.contains('dropzone')) return;

      const markerEl = findAncestorMarker(hit.object.el);
      if (!markerEl) return;
      const local = markerEl.object3D.worldToLocal(hit.point.clone());
      const anchor = (markerEl.id==='marker-hiro')?'hiro':'kanji';
      const pos = normalizeCoordinates(local.x, local.y, local.z);

      // 最小距离检查
      const distanceCheck = checkMinDistance(pos, anchor);
      if (!distanceCheck.allowed) { $status.textContent = `❌ ${distanceCheck.message}`; return; }

      CURRENT = { anchor, pos };
      $status.textContent = `已选位置：${anchor} (${pos.map(n=>n.toFixed(2)).join(', ')})`;
      showPreview(anchor, pos);
    });

    /******** 最小间距检查 ********/
    function checkMinDistance(newPos, anchor) {
      const MIN_DISTANCE = 0.25; // 25cm
      const parent = document.getElementById(`marker-${anchor}`);
      if (!parent) return { allowed: true, message: '' };
      const existingPins = parent.querySelectorAll('[id^="pin-"]');
      for (let pin of existingPins) {
        const posAttr = pin.getAttribute('position');
        if (posAttr) {
          const [px,py,pz] = posAttr.split(' ').map(parseFloat);
          const dx=newPos[0]-px, dy=newPos[1]-py, dz=newPos[2]-pz;
          const distance = Math.hypot(dx,dy,dz);
          if (distance < MIN_DISTANCE) {
            return { allowed:false, message:`距离现有文本太近(${(distance*100).toFixed(0)}cm)，请选择其他位置` };
          }
        }
      }
      return { allowed: true, message: '' };
    }

    /******** Firebase（你的配置） ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot,
      orderBy, query, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYsPxSPvpv8mPQdVGJuzE2TKZ0qY6e608",
      authDomain: "ar-maker-share.firebaseapp.com",
      projectId: "ar-maker-share",
      storageBucket: "ar-maker-share.appspot.com",
      messagingSenderId: "68968164615",
      appId: "1:68968164615:web:c56d3c17046ff51ebf29a2"
    };

    let db, pinsCol, isFirebaseConnected = false;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      pinsCol = collection(db, "pins");
      isFirebaseConnected = true;
    } catch (error) {
      console.error('Firebase 初始化失败:', error);
      $status.textContent = '❌ 数据库连接失败';
    }

    // 实时监听
    if (isFirebaseConnected) {
      const q = query(pinsCol, orderBy('ts','asc'));
      onSnapshot(q, (snap) => {
        snap.docChanges().forEach(ch => {
          const d = ch.doc.data();
          if (d.mode !== 'arjs') return;
          const anchor = (d.anchor === 'kanji') ? 'kanji' : 'hiro';
          const parent = document.getElementById(`marker-${anchor}`);
          if (!parent) return;

          let el = document.getElementById(`pin-${ch.doc.id}`);
          if (ch.type === 'removed') { if(el) el.remove(); return; }
          if (!el) { el = document.createElement('a-entity'); el.id = `pin-${ch.doc.id}`; parent.appendChild(el); }

          const [x,y,z] = d.pos || [0,0,0];
          el.setAttribute('position', `${x} ${y} ${z}`);

          if (d.modelUrl) {
            el.removeAttribute('text');
            const s = d.scale||1;
            el.setAttribute('gltf-model', d.modelUrl);
            el.setAttribute('scale', `${s} ${s} ${s}`);
          } else {
            const isMyPin = d.userId === USER_ID;
            const baseColor = anchor==='hiro' ? '#90EE90' : '#FFD166';
            const finalColor = isMyPin ? baseColor : '#CCCCCC';
            const s = d.scale||1;
            el.setAttribute('text', `value:${d.text||''}; align:center; width:1.8; color:${finalColor}; wrapCount:24`);
            el.setAttribute('scale', `${s} ${s} ${s}`);
          }
        });
      }, (error) => {
        console.error('Firebase 监听错误:', error);
        $status.textContent = '❌ 实时同步中断';
      });
    }

    // 写入 Firestore（带重试）
    async function savePinARJS({ anchor, pos, text, scale }, retryCount = 0) {
      if (!isFirebaseConnected) throw new Error('数据库未连接');
      try {
        return await addDoc(pinsCol, {
          mode:'arjs', anchor, pos, text, scale,
          userId: USER_ID, ts: serverTimestamp()
        });
      } catch (error) {
        if (retryCount < 2) {
          await new Promise(r => setTimeout(r, 1000));
          return savePinARJS({ anchor, pos, text, scale }, retryCount + 1);
        }
        throw error;
      }
    }

    // 表单提交
    $form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = ($msg.value||'').trim();
      const sc = parseFloat($scale.value||'1') || 1;

      if (!msg) return alert('请输入文本内容');
      if (!CURRENT.pos) return alert('请先在标记附近点击选择位置');
      if (!isOnline) return alert('网络离线，无法提交');
      if (!isFirebaseConnected) return alert('数据库连接失败，无法提交');

      const { anchor, pos } = CURRENT;
      // 再次最小间距检查
      const distanceCheck = checkMinDistance(pos, anchor);
      if (!distanceCheck.allowed) return alert(distanceCheck.message);

      try {
        $submitBtn.disabled = true;
        showPreview(anchor, pos, true);
        $status.textContent = '⏳ 正在提交...';

        await savePinARJS({ anchor, pos, text: msg, scale: sc });

        $status.textContent = '✅ 提交成功！';
        $msg.value = '';
        setTimeout(() => {
          const prev = document.getElementById(`preview-${anchor}`);
          const cur = document.getElementById(`cursor-${anchor}`);
          if (prev) prev.remove();
          if (cur) cur.remove();
          $status.textContent = '就绪 - 可继续添加文本';
          CURRENT = { anchor: null, pos: null };
        }, 2500);
      } catch (err) {
        console.error('提交失败:', err);
        $status.textContent = '❌ 提交失败，请重试';
        showPreview(anchor, pos, false);
      } finally {
        setTimeout(() => { if (isOnline && isFirebaseConnected) $submitBtn.disabled = false; }, 1000);
      }
    });

    // 防抖预览
    const debouncedPreview = debounce(() => { if (CURRENT.pos) showPreview(CURRENT.anchor, CURRENT.pos); }, 150);
    $msg.addEventListener('input', debouncedPreview);
    $scale.addEventListener('input', debouncedPreview);
  </script>
</body>
</html>