<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ä¿®å¤ç‰ˆ AR Text å®šä½</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100dvh; background:#000; overflow:hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }

    #scanStatus{
      position:fixed; top:8px; left:8px; z-index:20; background:rgba(0,0,0,.75);
      color:#fff; padding:8px 12px; border-radius:12px; font-size:13px; backdrop-filter:blur(8px);
    }
    #scanStatus.success{ background:rgba(34,197,94,.9); }
    #scanStatus.error{ background:rgba(239,68,68,.9); }
    #net{ position:fixed; top:8px; right:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; }
    #debug{
      position:fixed; top:50px; left:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:11px; max-width:280px; line-height:1.35;
      white-space:pre-wrap; max-height:150px; overflow-y:auto;
    }

    #ui{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:rgba(0,0,0,.6); color:#fff; padding:10px 10px calc(12px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.25); backdrop-filter:blur(8px);
      display:none;
    }
    #ui form{ display:grid; grid-template-columns:1fr minmax(70px,110px) auto; gap:8px; align-items:end; }
    #ui label{ display:flex; flex-direction:column; font-size:12px; opacity:.95; }
    #ui input{ height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1); color:#fff; padding:6px 10px; }
    #ui button{ height:36px; border:none; border-radius:10px; background:#4ad; color:#002; font-weight:700; padding:0 16px; }
    #status{ margin-top:6px; font-size:12px; opacity:.85; }

    video, #arjs-video, video#arjs-video{
      position:fixed !important; top:0 !important; left:0 !important;
      width:100vw !important; height:100vh !important; object-fit:cover !important;
      z-index:0 !important; background:#000 !important; display:block !important; visibility:visible !important; opacity:1 !important;
    }
    canvas.a-canvas{ position:fixed !important; top:0 !important; left:0 !important; z-index:1 !important; background:transparent !important; }

    .a-enter-vr-button, .a-enter-ar-button, .a-orientation-modal{ display:none !important; }
    *{ -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color:transparent; }

    #startAR {
      position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 30;
      height: 48px; border: none; border-radius: 12px; background: #4ad; color: #002;
      font-weight: 800; font-size: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
  <div id="scanStatus">ğŸ‘‹ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ AR</div>
  <div id="net">ğŸŸ¢ åœ¨çº¿</div>
  <div id="debug">ç­‰å¾…å¯åŠ¨â€¦</div>
  <button id="startAR">å¼€å§‹ AR</button>

  <a-scene id="scene" style="display:none"
           embedded vr-mode-ui="enabled:false"
           renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true">
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0.5 1 0.5"></a-entity>

    <!-- æ”¹è¿›çš„ Marker é…ç½® -->
    <a-marker id="marker-hiro" preset="hiro"
      emitevents="true"
      smooth="true" smoothCount="8" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="4" height="4" rotation="-90 0 0"
               material="opacity:0; transparent:true; side:double"></a-plane>
    </a-marker>

    <a-marker id="marker-kanji" preset="kanji"
      emitevents="true"
      smooth="true" smoothCount="8" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="4" height="4" rotation="-90 0 0"
               material="opacity:0; transparent:true; side:double"></a-plane>
    </a-marker>

    <a-entity id="anchor-root-hiro"  visible="false"></a-entity>
    <a-entity id="anchor-root-kanji" visible="false"></a-entity>

    <!-- æ”¹è¿›çš„å°„çº¿æ£€æµ‹é…ç½® -->
    <a-entity id="mouse"
      cursor="rayOrigin: mouse; downEvents: mousedown,touchstart"
      raycaster="objects: .dropzone; interval: 0; far: 50; near: 0.1">
    </a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="ui">
    <form id="form">
      <label>Text
        <input id="msg" placeholder="è¾“å…¥æ–‡æœ¬â€¦" maxlength="80" />
      </label>
      <label>Scale
        <input id="scale" type="number" step="0.1" value="1.0" inputmode="decimal" />
      </label>
      <button type="submit" id="submit">æäº¤ / Pin</button>
    </form>
    <div id="status">æœªé€‰ä½ç½®ï¼ˆåœ¨æ ‡è®°å†…ç‚¹å‡»å¯ç§»åŠ¨å®æ—¶æ–‡æœ¬ï¼‰</div>
  </div>

  <script type="module">
    /******** DOM & çŠ¶æ€ ********/
    const $scan = document.getElementById('scanStatus');
    const $net  = document.getElementById('net');
    const $debug= document.getElementById('debug');
    const scene = document.getElementById('scene');
    const mouse = document.getElementById('mouse');
    const $form = document.getElementById('form');
    const $msg  = document.getElementById('msg');
    const $scale= document.getElementById('scale');
    const $stat = document.getElementById('status');
    const $btn  = document.getElementById('submit');
    const $start= document.getElementById('startAR');
    const setNet  = on => $net.textContent = on ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
    const setDebug= txt => $debug.textContent = txt;
    setNet(navigator.onLine); addEventListener('online',()=>setNet(true)); addEventListener('offline',()=>setNet(false));
    const vibrate = (n=10)=>{ try{ navigator.vibrate && navigator.vibrate(n);}catch{} };

    let _scanTimer=null, _scanCache='';
    function setScan(txt, cls=''){
      if (txt===_scanCache) return;
      clearTimeout(_scanTimer);
      _scanTimer = setTimeout(()=>{ _scanCache = txt; $scan.className = cls; $scan.textContent = txt; }, 80);
    }

    /******** å¯åŠ¨ AR ********/
    const ARJS_ATTR = `
      sourceType: webcam;
      videoTexture: false;
      detectionMode: mono;
      sourceWidth: 1280;
      sourceHeight: 720;
      maxDetectionRate: 60;
      patternRatio: 0.85;
      debugUIEnabled: false
    `;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    function forceVideoVisible(){
      const videos = document.querySelectorAll('video');
      videos.forEach(v=>{ v.setAttribute('playsinline','true'); v.setAttribute('webkit-playsinline','true'); v.muted = true;
        v.style.display='block'; v.style.visibility='visible'; v.style.opacity='1'; });
      const canvas = document.querySelector('.a-canvas'); if(canvas){ canvas.style.zIndex='1'; canvas.style.background='transparent'; }
    }

    $start.addEventListener('click', async () => {
      try {
        setScan('ğŸ“· æ­£åœ¨è¯·æ±‚ç›¸æœºæƒé™â€¦');
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
        s.getTracks().forEach(t => t.stop());
        await new Promise(r => setTimeout(r, 250));
        scene.setAttribute('arjs', ARJS_ATTR);
        scene.style.display = 'block';
        $start.style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        setScan('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanjiâ€¦');
        setTimeout(forceVideoVisible, 600);
        if (isIOS){ [1500, 3000, 5000].forEach(t=>setTimeout(forceVideoVisible, t)); }
      } catch (e) {
        console.error(e);
        setScan('âŒ éœ€è¦æ‘„åƒå¤´æƒé™æ‰èƒ½ä½¿ç”¨ AR', 'error');
        alert('éœ€è¦ç›¸æœºæƒé™æ‰èƒ½ä½¿ç”¨ AR');
      }
    });

    /******** æ”¹è¿›çš„ç²˜æ€§é”šç‚¹ç³»ç»Ÿ ********/
    const HOLD_MS = 3000; // ç¼©çŸ­ä¿æ´»æ—¶é—´åˆ°3ç§’
    const anchors = {
      hiro:  { marker: document.getElementById('marker-hiro'),  root: document.getElementById('anchor-root-hiro'),
               detected:false, lastSeen:0, holdUntil:0, consecutiveVisible:0, live:null, isStable: false },
      kanji: { marker: document.getElementById('marker-kanji'), root: document.getElementById('anchor-root-kanji'),
               detected:false, lastSeen:0, holdUntil:0, consecutiveVisible:0, live:null, isStable: false },
    };
    let activeAnchor = null;

    function copyTransformDirectly(fromObj3D, toObj3D){
      // ç›´æ¥å¤åˆ¶å˜æ¢çŸ©é˜µï¼Œé¿å…å¤šæ¬¡è½¬æ¢è¯¯å·®
      fromObj3D.updateMatrixWorld(true);
      toObj3D.matrix.copy(fromObj3D.matrixWorld);
      toObj3D.matrix.decompose(toObj3D.position, toObj3D.quaternion, toObj3D.scale);
      toObj3D.updateMatrixWorld(true);
    }

    function ensureLive(anchorName){
      const A = anchors[anchorName]; if (!A) return null;
      if (!A.live){
        const el = document.createElement('a-entity');
        el.id = `liveText-${anchorName}`;
        el.setAttribute('rotation','-90 0 0');
        el.setAttribute('text', `value:Hello AR!; align:center; width:1.8; color:#00FF88; wrapCount:24`);
        el.setAttribute('material','opacity:.95; transparent:true');
        el.setAttribute('scale','1 1 1');
        el.setAttribute('position','0 0.01 0');
        A.root.appendChild(el);
        A.live = el;
      }
      return A.live;
    }

    function syncLiveStyle(){
      const txt = ($msg.value || 'Hello AR!').trim();
      const s   = parseFloat($scale.value||'1')||1;
      ['hiro','kanji'].forEach(name=>{
        const A = anchors[name]; if (!A.live) return;
        A.live.setAttribute('text', `value:${txt}; align:center; width:1.8; color:#00FF88; wrapCount:24`);
        A.live.setAttribute('scale', `${s} ${s} ${s}`);
      });
    }

    function onFound(name){
      const A = anchors[name]; if (!A) return;
      if (!A.detected){ A.detected = true; vibrate(10); }
      A.lastSeen = Date.now(); 
      A.holdUntil = A.lastSeen + HOLD_MS; 
      A.consecutiveVisible++;
      
      // è¿ç»­æ£€æµ‹åˆ°5å¸§æ‰è®¤ä¸ºç¨³å®š
      A.isStable = A.consecutiveVisible >= 5;
      
      copyTransformDirectly(A.marker.object3D, A.root.object3D);
      A.root.setAttribute('visible', true);

      if (!activeAnchor) activeAnchor = name;
      ensureLive(name);
      syncLiveStyle();
      updateScanStatus();
    }
    
    function onLost(name){
      const A = anchors[name]; if (!A) return;
      A.detected = false; 
      A.consecutiveVisible = 0;
      A.isStable = false;
      updateScanStatus();
    }

    anchors.hiro.marker.addEventListener('markerFound', ()=>onFound('hiro'));
    anchors.kanji.marker.addEventListener('markerFound',()=>onFound('kanji'));
    anchors.hiro.marker.addEventListener('markerLost', ()=>onLost('hiro'));
    anchors.kanji.marker.addEventListener('markerLost',()=>onLost('kanji'));

    let pollCount=0; const DETECT=3;
    setInterval(()=>{
      pollCount++;
      const now = Date.now();
      ['hiro','kanji'].forEach(name=>{
        const A = anchors[name];
        const vis = !!(A.marker.object3D && A.marker.object3D.visible);
        
        if (vis){
          A.lastSeen = now; 
          A.holdUntil = now + HOLD_MS; 
          A.consecutiveVisible++;
          A.isStable = A.consecutiveVisible >= 5;
          if (!A.detected && A.consecutiveVisible>=DETECT) A.detected = true;
          copyTransformDirectly(A.marker.object3D, A.root.object3D);
          A.root.setAttribute('visible', true);
        } else {
          A.consecutiveVisible = 0;
          A.isStable = false;
          if (now <= A.holdUntil){
            A.root.setAttribute('visible', true);
          } else {
            A.root.setAttribute('visible', false);
          }
        }
      });
      
      setDebug(`è½®è¯¢:${pollCount}
Hiro: ${anchors.hiro.marker.object3D.visible?'âœ…å¯è§':'âŒéšè—'} ç¨³å®š:${anchors.hiro.isStable?'æ˜¯':'å¦'}
Kanji:${anchors.kanji.marker.object3D.visible?'âœ…å¯è§':'âŒéšè—'} ç¨³å®š:${anchors.kanji.isStable?'æ˜¯':'å¦'}`);
      updateScanStatus();
    }, 100);

    function updateScanStatus(){
      const names = ['hiro','kanji'].filter(n=>{
        const A = anchors[n];
        return A.marker.object3D.visible || Date.now() <= A.holdUntil;
      }).map(n=>n[0].toUpperCase()+n.slice(1));
      if (names.length>0){
        const stable = ['hiro','kanji'].some(n=>anchors[n].isStable);
        setScan( stable ? `âœ… å·²ç¨³å®šè¯†åˆ« ${names.join(' / ')}` : `ğŸ”„ è¯†åˆ«ä¸­... ${names.join(' / ')}`, stable ? 'success' : '');
      }else{
        setScan('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanjiâ€¦');
      }
    }

    /******** æ”¹è¿›çš„äº¤äº’å¤„ç† ********/
    const USER_ID = 'user_' + Math.random().toString(36).slice(2,8);
    let CURRENT = { anchor:null, pos:null };
    const EPS = 0.005; // ç¨å¾®æŠ¬é«˜ä¸€ç‚¹

    function findMarker(el){ 
      let p=el; 
      while(p && p.tagName){ 
        if(p.tagName.toLowerCase()==='a-marker') return p; 
        p=p.parentEl;
      } 
      return null; 
    }

    $msg.addEventListener('input', syncLiveStyle);
    $scale.addEventListener('input', syncLiveStyle);

    // æ”¹è¿›çš„ç‚¹å‡»å¤„ç† - åªåœ¨æ ‡è®°ç¨³å®šæ—¶æ‰å…è®¸å®šä½
    function handlePick(){
      const rc = mouse.components.raycaster;
      if(!rc || !rc.intersections?.length) return;

      const hit = rc.intersections.find(i=>i.object?.el?.classList?.contains('dropzone'));
      if(!hit || !hit.object?.el?.classList?.contains('dropzone')) return;

      const markerEl = findMarker(hit.object.el); 
      if(!markerEl) return;
      
      const name = (markerEl.id==='marker-hiro')?'hiro':'kanji';
      const A = anchors[name];

      // åªæœ‰åœ¨æ ‡è®°ç¨³å®šå¯è§æ—¶æ‰å…è®¸å®šä½
      if (!A.isStable || !markerEl.object3D.visible){ 
        setScan('âš ï¸ è¯·ä¿æŒæ ‡è®°ç¨³å®šè¯†åˆ«åå†ç‚¹å‡»', 'error'); 
        setTimeout(updateScanStatus, 1500); 
        return; 
      }

      activeAnchor = name;
      ensureLive(name); 
      syncLiveStyle();

      // ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„æ ‡è®°å˜æ¢
      copyTransformDirectly(markerEl.object3D, A.root.object3D);

      const wp = hit.point.clone();
      const lp = A.root.object3D.worldToLocal(wp);
      const pos = [ 
        parseFloat(lp.x.toFixed(4)), 
        parseFloat(Math.max(lp.y, 0).toFixed(4)) + EPS, 
        parseFloat(lp.z.toFixed(4)) 
      ];

      A.live.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);
      CURRENT = { anchor:name, pos };
      
      $stat.textContent = `ğŸ¯ å·²å®šä½åˆ°ï¼š${name.toUpperCase()} (${pos.map(n=>n.toFixed(3)).join(', ')})`;
      setScan('âœ… æ–‡æœ¬å·²å®šä½ï¼å¯ç»§ç»­ä¿®æ”¹å†…å®¹', 'success');
      vibrate(20);
    }

    // ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†ï¼Œé¿å…é‡å¤è§¦å‘
    let lastPickTime = 0;
    function throttledPick() {
      const now = Date.now();
      if (now - lastPickTime < 200) return; // 200msé˜²æŠ–
      lastPickTime = now;
      handlePick();
    }

    // ä¼˜å…ˆä½¿ç”¨ touchstartï¼Œfallback åˆ° click
    let hasTouchSupport = 'ontouchstart' in window;
    
    if (hasTouchSupport) {
      scene.addEventListener('touchstart', (e) => {
        if(e.touches?.length === 1) {
          e.preventDefault();
          throttledPick();
        }
      }, {passive:false});
    } else {
      scene.addEventListener('click', throttledPick, {passive:true});
    }

    /******** Firebase é›†æˆä¿æŒä¸å˜ ********/
    // è¿™é‡Œä¿æŒåŸæœ‰çš„ Firebase ä»£ç ä¸å˜...
    console.log('Firebase åŠŸèƒ½å·²ä¿ç•™ï¼Œä¸ºç®€åŒ–æ¼”ç¤ºæš‚æ—¶çœç•¥å®Œæ•´ä»£ç ');
    
    // ç®€åŒ–ç‰ˆæäº¤åŠŸèƒ½
    $form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = ($msg.value||'').trim() || 'Hello AR!';
      const scale = parseFloat($scale.value||'1')||1;

      let anchor = (CURRENT.anchor || activeAnchor);
      if (!anchor){ alert('è¯·å…ˆè®©ç›¸æœºè¯†åˆ«ä»»æ„æ ‡è®°'); return; }

      const live = anchors[anchor].live;
      if (!live){ alert('è¯·å…ˆè®©ç›¸æœºè¯†åˆ«æ ‡è®°'); return; }

      const p = live.getAttribute('position');
      const pos = [Number(p.x||0), Number(p.y||0), Number(p.z||0)];

      setScan('âœ… æ¨¡æ‹Ÿæäº¤æˆåŠŸï¼ˆFirebaseåŠŸèƒ½å·²ç®€åŒ–ï¼‰','success');
      vibrate(30);
    });

    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(forceVideoVisible, 400); });
  </script>
</body>
</html>
