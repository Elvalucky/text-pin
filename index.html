<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shared AR Text ‚Äî Hiro Marker + Click + Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.js"></script>

  <!-- Preload Firebase (smoother first frame) -->
  <script type="module">
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  </script>

  <style>
    html, body { margin:0; padding:0; height:100dvh; background:#000; overflow:hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }

    #scanStatus{
      position:fixed; top:8px; left:8px; z-index:20; background:rgba(0,0,0,.75);
      color:#fff; padding:8px 12px; border-radius:12px; font-size:13px; backdrop-filter:blur(8px);
      transition:.2s;
    }
    #scanStatus.success{ background:rgba(34,197,94,.9); }
    #scanStatus.error{ background:rgba(239,68,68,.9); }

    #net{ position:fixed; top:8px; right:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; }

    #debug{ position:fixed; top:52px; left:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:11px; max-width:280px; line-height:1.35;
      white-space:pre-wrap; max-height:150px; overflow-y:auto; }

    #ui{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:rgba(0,0,0,.6); color:#fff; padding:10px 10px calc(12px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.25); backdrop-filter:blur(8px);
      display:none;
    }
    #ui form{ display:grid; grid-template-columns:1fr minmax(70px,110px) auto; gap:8px; align-items:end; }
    #ui label{ display:flex; flex-direction:column; font-size:12px; opacity:.95; }
    #ui input{ height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1); color:#fff; padding:6px 10px; }
    #ui button{ height:36px; border:none; border-radius:10px; background:#4ad; color:#002; font-weight:700; padding:0 16px; }
    #status{ margin-top:6px; font-size:12px; opacity:.85; }

    /* Camera video behind, WebGL on top */
    video, #arjs-video, video#arjs-video{
      position:fixed !important; top:0 !important; left:0 !important;
      width:100vw !important; height:100vh !important; object-fit:cover !important;
      z-index:0 !important; background:#000 !important; display:block !important; visibility:visible !important; opacity:1 !important;
    }
    canvas.a-canvas{ position:fixed !important; top:0 !important; left:0 !important; z-index:1 !important; background:transparent !important; }

    .a-enter-vr-button, .a-enter-ar-button, .a-orientation-modal{ display:none !important; }
    *{ -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color:transparent; }

    #startAR {
      position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 30;
      height: 48px; border: none; border-radius: 12px; background: #4ad; color: #002;
      font-weight: 800; font-size: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
  <div id="scanStatus">üëã Tap the button below to start AR</div>
  <div id="net">üü¢ Online</div>
  <div id="debug">Waiting‚Ä¶</div>
  <button id="startAR">Start AR</button>

  <a-scene id="scene" style="display:none"
           embedded vr-mode-ui="enabled:false"
           renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true">
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0.5 1 0.5"></a-entity>

    <!-- Hiro marker: used only for detection + pose -->
    <a-marker id="marker-hiro" preset="hiro"
      emitevents="true"
      smooth="true" smoothCount="12" smoothTolerance="0.015" smoothThreshold="8">
      <!-- Invisible picking plane (optional) -->
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0"
               material="opacity:0; transparent:true; side:double"></a-plane>
    </a-marker>

    <!-- Anchor root: all content attaches here -->
    <a-entity id="anchor-root-hiro" visible="false"></a-entity>

    <a-entity camera></a-entity>
  </a-scene>

  <div id="ui">
    <form id="form">
      <label>Text
        <input id="msg" placeholder="Type text‚Ä¶" maxlength="80" />
      </label>
      <label>Scale
        <input id="scale" type="number" step="0.1" value="1.0" inputmode="decimal" />
      </label>
      <button type="submit" id="submit">Submit / Pin</button>
    </form>
    <div id="status">Tip: tap anywhere in the view to move the live text.</div>
  </div>

  <script type="module">
    /******** DOM & state ********/
    const $scan  = document.getElementById('scanStatus');
    const $net   = document.getElementById('net');
    const $debug = document.getElementById('debug');
    const scene  = document.getElementById('scene');
    const $form  = document.getElementById('form');
    const $msg   = document.getElementById('msg');
    const $scale = document.getElementById('scale');
    const $stat  = document.getElementById('status');
    const $btn   = document.getElementById('submit');
    const $start = document.getElementById('startAR');

    const setNet   = on => $net.textContent = on ? 'üü¢ Online' : 'üî¥ Offline';
    const setDebug = txt => $debug.textContent = txt;
    setNet(navigator.onLine); addEventListener('online',()=>setNet(true)); addEventListener('offline',()=>setNet(false));
    const vibrate = (n=10)=>{ try{ navigator.vibrate && navigator.vibrate(n);}catch{} };

    let _scanTimer=null, _scanCache='';
    function setScan(txt, cls=''){
      if (txt===_scanCache) return;
      clearTimeout(_scanTimer);
      _scanTimer = setTimeout(()=>{ _scanCache = txt; $scan.className = cls; $scan.textContent = txt; }, 80);
    }

    /******** Boot AR ********/
    const ARJS_ATTR = `
      sourceType: webcam;
      videoTexture: false;
      detectionMode: mono;
      sourceWidth: 1280;
      sourceHeight: 720;
      maxDetectionRate: 60;
      patternRatio: 0.85;
      debugUIEnabled: false
    `;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    function forceVideoVisible(){
      const videos = document.querySelectorAll('video');
      videos.forEach(v=>{ v.setAttribute('playsinline','true'); v.setAttribute('webkit-playsinline','true'); v.muted = true;
        v.style.display='block'; v.style.visibility='visible'; v.style.opacity='1'; });
      const canvas = document.querySelector('.a-canvas'); if(canvas){ canvas.style.zIndex='1'; canvas.style.background='transparent'; canvas.style.touchAction='none'; }
    }

    $start.addEventListener('click', async () => {
      try {
        setScan('üì∑ Requesting camera permission‚Ä¶');
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
        s.getTracks().forEach(t => t.stop());
        await new Promise(r => setTimeout(r, 250));
        scene.setAttribute('arjs', ARJS_ATTR);
        scene.style.display = 'block';
        $start.style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        setScan('üîé Scanning Hiro marker‚Ä¶');
        setTimeout(forceVideoVisible, 600);
        if (isIOS){ [1500, 3000, 5000].forEach(t=>setTimeout(forceVideoVisible, t)); }
      } catch (e) {
        console.error(e);
        setScan('‚ùå Camera permission is required', 'error');
        alert('Camera permission is required to use AR.');
      }
    });

    /******** Sticky anchor + 5s keep-alive ********/
    const HOLD_MS = 5000;
    const anchors = {
      hiro:  { marker: document.getElementById('marker-hiro'),  root: document.getElementById('anchor-root-hiro'),
               detected:false, lastSeen:0, holdUntil:0, consecutiveVisible:0, live:null, lastTransform:null },
    };
    let activeAnchor = 'hiro';

    function copyWorldTransform(fromObj3D, toObj3D){
      fromObj3D.updateMatrixWorld(true);
      toObj3D.position.setFromMatrixPosition(fromObj3D.matrixWorld);
      toObj3D.quaternion.setFromRotationMatrix(fromObj3D.matrixWorld);
      const sx = new THREE.Vector3().setFromMatrixScale(fromObj3D.matrixWorld);
      toObj3D.scale.copy(sx);
      toObj3D.updateMatrixWorld(true);
    }

    function saveLastTransform(name){
      const mk = anchors[name].marker.object3D;
      mk.updateMatrixWorld(true);
      const pos = new THREE.Vector3(); const quat = new THREE.Quaternion(); const scl = new THREE.Vector3();
      mk.matrixWorld.decompose(pos, quat, scl);
      anchors[name].lastTransform = { pos, quat, scl };
    }
    function applyLastTransform(name){
      const A = anchors[name]; if(!A.lastTransform) return;
      A.root.object3D.position.copy(A.lastTransform.pos);
      A.root.object3D.quaternion.copy(A.lastTransform.quat);
      A.root.object3D.scale.copy(A.lastTransform.scl);
      A.root.object3D.updateMatrixWorld(true);
    }

    function ensureLive(name){
      const A = anchors[name]; if (!A) return null;
      if (!A.live){
        const el = document.createElement('a-entity');
        el.id = `liveText-${name}`;
        el.setAttribute('rotation','-90 0 0');
        el.setAttribute('text', `value:Hello AR!; align:center; width:1.8; color:#00FF88; wrapCount:24`);
        el.setAttribute('material','opacity:1; transparent:true');
        el.setAttribute('scale','1 1 1');
        el.setAttribute('position','0 0.01 0');
        A.root.appendChild(el);
        A.live = el;
      }
      return A.live;
    }

    function syncLiveStyle(){
      const txt = ($msg.value || 'Hello AR!').trim();
      const s   = parseFloat($scale.value||'1')||1;
      const A = anchors.hiro; if (!A.live) return;
      A.live.setAttribute('text', `value:${txt}; align:center; width:1.8; color:#00FF88; wrapCount:24`);
      A.live.setAttribute('scale', `${s} ${s} ${s}`);
    }

    function onFound(){
      const A = anchors.hiro;
      if (!A.detected){ A.detected = true; vibrate(10); }
      A.lastSeen = Date.now(); A.holdUntil = A.lastSeen + HOLD_MS; A.consecutiveVisible++;
      copyWorldTransform(A.marker.object3D, A.root.object3D);
      saveLastTransform('hiro');
      A.root.setAttribute('visible', true);
      ensureLive('hiro'); syncLiveStyle(); updateScanStatus();
    }
    function onLost(){
      const A = anchors.hiro;
      A.detected = false; A.consecutiveVisible = 0;
      saveLastTransform('hiro'); updateScanStatus();
    }

    anchors.hiro.marker.addEventListener('markerFound', onFound);
    anchors.hiro.marker.addEventListener('markerLost',  onLost);

    let pollCount=0; const DETECT=3, HARD_LOST_TIMEOUT=2000;
    setInterval(()=>{
      pollCount++;
      const now = Date.now();
      const A = anchors.hiro;
      const vis = !!(A.marker.object3D && A.marker.object3D.visible);
      if (vis){
        A.lastSeen = now; A.holdUntil = now + HOLD_MS; A.consecutiveVisible++;
        if (!A.detected && A.consecutiveVisible>=DETECT) A.detected = true;
        copyWorldTransform(A.marker.object3D, A.root.object3D);
        saveLastTransform('hiro');
        A.root.setAttribute('visible', true);
      }else{
        A.consecutiveVisible = 0;
        if (now <= A.holdUntil){
          applyLastTransform('hiro');
          A.root.setAttribute('visible', true);
        }else if (now - A.lastSeen > HARD_LOST_TIMEOUT){
          A.root.setAttribute('visible', false);
        }
      }
      setDebug(`poll: ${pollCount}
Hiro: ${A.marker.object3D.visible?'‚úÖ visible':'‚ùå hidden'}  keep-alive: ${Math.max(0,A.holdUntil-now)}ms`);
      updateScanStatus();
    }, 120);

    function updateScanStatus(){
      const A = anchors.hiro;
      if (A.marker.object3D.visible || Date.now() <= A.holdUntil){
        const holding = !A.marker.object3D.visible && Date.now()<=A.holdUntil;
        setScan( holding ? '‚úÖ Hiro recognized (sticky)' : '‚úÖ Hiro recognized', 'success');
      }else{
        setScan('üîé Scanning Hiro marker‚Ä¶');
      }
    }

    /******** Accurate picking on canvas (screen ‚Üí ray ‚Üí plane) ********/
    function bindCanvasPointer(){
      const canvas = document.querySelector('canvas.a-canvas');
      if (!canvas) return;
      canvas.style.touchAction = 'none';
      canvas.addEventListener('pointerdown', (e)=>{
        if (e.target.closest && e.target.closest('#ui')) return;
        e.preventDefault();
        handlePointer(e.clientX, e.clientY, canvas);
      }, {passive:false});
    }
    scene.addEventListener('loaded', bindCanvasPointer);

    function pickOnAnchorPlaneFromScreen(clientX, clientY, canvasEl){
      const cam = scene.camera;
      if (!cam) return null;

      const root = anchors.hiro.root.object3D;
      root.updateMatrixWorld(true);

      const canvas = canvasEl || document.querySelector('canvas.a-canvas');
      if (!canvas) return null;
      const rect = canvas.getBoundingClientRect();
      const ndc = new THREE.Vector2(
        ((clientX - rect.left) / rect.width) * 2 - 1,
        -((clientY - rect.top) / rect.height) * 2 + 1
      );

      // Plane normal of local XZ
      const p0 = root.localToWorld(new THREE.Vector3(0,0,0));
      const px = root.localToWorld(new THREE.Vector3(1,0,0)).sub(p0);
      const pz = root.localToWorld(new THREE.Vector3(0,0,1)).sub(p0);
      const normal = new THREE.Vector3().copy(pz).cross(px).normalize();
      const plane = new THREE.Plane().setFromNormalAndCoplanarPoint(normal, p0);

      const raycaster = new THREE.Raycaster();
      raycaster.setFromCamera(ndc, cam);

      const wp = new THREE.Vector3();
      if (!raycaster.ray.intersectPlane(plane, wp)) return null;

      const lp = root.worldToLocal(wp.clone());
      const EPS = 0.002;
      return [ lp.x, Math.max(lp.y,0)+EPS, lp.z ];
    }

    function handlePointer(clientX, clientY, canvasEl){
      const A = anchors.hiro;
      if (!(A.marker.object3D.visible || Date.now() <= A.holdUntil)){
        setScan('‚ö†Ô∏è Put the Hiro marker in view first', 'error'); return;
      }

      // Sync pose: live or last
      if (A.marker.object3D.visible) {
        copyWorldTransform(A.marker.object3D, A.root.object3D);
        saveLastTransform('hiro');
      } else {
        applyLastTransform('hiro');
      }

      ensureLive('hiro'); syncLiveStyle();

      const pos = pickOnAnchorPlaneFromScreen(clientX, clientY, canvasEl);
      if (!pos) return;

      A.live.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);
      CURRENT = { anchor:'hiro', pos };
      $stat.textContent = `üéØ Moved to: HIRO (${pos.map(n=>n.toFixed(3)).join(', ')})`;
      setScan('‚úÖ Text moved; keep typing or Pin', 'success');
      vibrate(12);
    }

    // Live text updates while typing
    $msg.addEventListener('input', syncLiveStyle);
    $scale.addEventListener('input', syncLiveStyle);

    /******** Firebase: only saved when you Pin (local coords stay fixed) ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYsPxSPvpv8mPQdVGJuzE2TKZ0qY6e608",
      authDomain: "ar-maker-share.firebaseapp.com",
      projectId: "ar-maker-share",
      storageBucket: "ar-maker-share.appspot.com",
      messagingSenderId: "68968164615",
      appId: "1:68968164615:web:c56d3c17046ff51ebf29a2"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const pins = collection(db, "pins");
    const USER_ID = 'user_' + Math.random().toString(36).slice(2,8);
    let CURRENT = { anchor:null, pos:null };

    // Render pins under anchor-root-hiro (local coords preserved)
    const q = query(pins, orderBy('ts','asc'));
    onSnapshot(q, (snap)=>{
      snap.docChanges().forEach(ch=>{
        const d = ch.doc.data();
        if(d.mode!=='arjs') return;
        if(d.anchor && d.anchor!=='hiro') return; // we only show Hiro pins here

        const parent = anchors.hiro.root; if(!parent) return;

        if(ch.type==='removed'){ const old=document.getElementById(`pin-${ch.doc.id}`); if(old) old.remove(); return; }
        let el = document.getElementById(`pin-${ch.doc.id}`);
        if(!el){ el=document.createElement('a-entity'); el.id=`pin-${ch.doc.id}`; parent.appendChild(el); }
        const [x,y,z] = d.pos || [0,0,0];
        el.setAttribute('position', `${x} ${y} ${z}`);

        if(d.modelUrl){
          el.removeAttribute('text');
          const s=d.scale||1; el.setAttribute('gltf-model', d.modelUrl); el.setAttribute('scale', `${s} ${s} ${s}`);
        }else{
          const mine = d.userId===USER_ID;
          const color= mine ? '#90EE90' : '#ccc';
          const s=d.scale||1;
          el.setAttribute('rotation','-90 0 0');
          el.setAttribute('text', `value:${d.text||''}; align:center; width:1.8; color:${color}; wrapCount:24`);
          el.setAttribute('scale', `${s} ${s} ${s}`);
        }
      });
    });

    async function savePin({anchor,pos,text,scale}){
      return await addDoc(pins, {
        mode:'arjs', anchor, pos, text, scale, userId: USER_ID, ts: serverTimestamp()
      });
    }

    $form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = ($msg.value||'').trim() || 'Hello AR!';
      const scale = parseFloat($scale.value||'1')||1;

      const live = anchors.hiro.live;
      if (!live){ alert('Please show the Hiro marker first.'); return; }

      const p = live.getAttribute('position');
      const pos = [Number(p.x||0), Number(p.y||0), Number(p.z||0)];

      try{
        $btn.disabled = true;
        setScan('‚è≥ Saving‚Ä¶');
        await savePin({anchor:'hiro',pos,text,scale});
        setScan('‚úÖ Saved. Others will see it too.', 'success');
        vibrate(30);
      }catch(err){
        console.error(err);
        setScan('‚ùå Save failed', 'error');
      }finally{
        setTimeout(()=>{ $btn.disabled=false; }, 600);
      }
    });

    // Ensure video visible when returning to foreground
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(forceVideoVisible, 400); });
  </script>
</body>
</html>
