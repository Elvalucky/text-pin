<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Shared AR Text â€” Marker + Click + Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.3/aframe/build/aframe-ar.js"></script>

  <!-- é¢„åŠ è½½ Firebase æ¨¡å—ï¼ˆå‡å°‘é¦–å¸§é—ªçƒï¼‰ -->
  <script type="module">
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  </script>

  <style>
    html, body { margin:0; padding:0; height:100dvh; background:#000; overflow:hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }

    #scanStatus{
      position:fixed; top:8px; left:8px; z-index:20; background:rgba(0,0,0,.75);
      color:#fff; padding:8px 12px; border-radius:12px; font-size:13px; backdrop-filter:blur(8px);
    }
    #scanStatus.success{ background:rgba(34,197,94,.9); }
    #scanStatus.error{ background:rgba(239,68,68,.9); }
    #net{ position:fixed; top:8px; right:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:12px; }
    #debug{
      position:fixed; top:50px; left:8px; z-index:20; background:rgba(0,0,0,.6);
      color:#fff; padding:6px 10px; border-radius:10px; font-size:11px; max-width:280px; line-height:1.35;
      white-space:pre-wrap; max-height:150px; overflow-y:auto;
    }

    #ui{
      position:fixed; left:0; right:0; bottom:0; z-index:20;
      background:rgba(0,0,0,.6); color:#fff; padding:10px 10px calc(12px + env(safe-area-inset-bottom));
      box-shadow:0 -8px 24px rgba(0,0,0,.25); backdrop-filter:blur(8px);
      display:none;
    }
    #ui form{ display:grid; grid-template-columns:1fr minmax(70px,110px) auto; gap:8px; align-items:end; }
    #ui label{ display:flex; flex-direction:column; font-size:12px; opacity:.95; }
    #ui input{ height:36px; border-radius:10px; border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.1); color:#fff; padding:6px 10px; }
    #ui button{ height:36px; border:none; border-radius:10px; background:#4ad; color:#002; font-weight:700; padding:0 16px; }
    #status{ margin-top:6px; font-size:12px; opacity:.85; }

    /* ç›¸æœºç”»é¢å¯è§ï¼ˆDOMè§†é¢‘åšåº•ã€WebGLç”»å¸ƒåœ¨ä¸Šï¼‰ */
    video, #arjs-video, video#arjs-video{
      position:fixed !important; top:0 !important; left:0 !important;
      width:100vw !important; height:100vh !important; object-fit:cover !important;
      z-index:0 !important; background:#000 !important; display:block !important; visibility:visible !important; opacity:1 !important;
    }
    canvas.a-canvas{ position:fixed !important; top:0 !important; left:0 !important; z-index:1 !important; background:transparent !important; }

    .a-enter-vr-button, .a-enter-ar-button, .a-orientation-modal{ display:none !important; }
    *{ -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; -webkit-tap-highlight-color:transparent; }

    #startAR {
      position: fixed; left: 12px; right: 12px; bottom: 12px; z-index: 30;
      height: 48px; border: none; border-radius: 12px; background: #4ad; color: #002;
      font-weight: 800; font-size: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
  <div id="scanStatus">ğŸ‘‹ ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ AR</div>
  <div id="net">ğŸŸ¢ åœ¨çº¿</div>
  <div id="debug">ç­‰å¾…å¯åŠ¨â€¦</div>
  <button id="startAR">å¼€å§‹ AR</button>

  <a-scene id="scene" style="display:none"
           embedded vr-mode-ui="enabled:false"
           renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true; antialias:true">
    <a-entity light="type:ambient; intensity:0.8"></a-entity>
    <a-entity light="type:directional; intensity:0.9" position="0.5 1 0.5"></a-entity>

    <!-- 1) ä¸¤ä¸ª Markerï¼ˆåªè´Ÿè´£â€œæ£€æµ‹ + ç‚¹é€‰â€ï¼‰ -->
    <a-marker id="marker-hiro" preset="hiro" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
      <a-box class="marker-indicator" position="0 0.2 0" width="0.2" height="0.3" depth="0.2"
             material="color:#19d47d; opacity:0.9"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear"></a-box>
    </a-marker>

    <a-marker id="marker-kanji" preset="kanji" emitevents="true" smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5">
      <a-plane class="dropzone" width="6" height="6" rotation="-90 0 0" material="opacity:0; transparent:true"></a-plane>
      <a-box class="marker-indicator" position="0 0.2 0" width="0.2" height="0.3" depth="0.2"
             material="color:#ffd166; opacity:0.9"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear"></a-box>
    </a-marker>

    <!-- 2) ä¸¤ä¸ªâ€œé”šç‚¹æ ¹èŠ‚ç‚¹â€ï¼šæ‰€æœ‰ Pin éƒ½æŒ‚åœ¨è¿™é‡Œï¼ˆåšâ€˜ä¸¢å¤±ä¿æ´»â€™ï¼‰ -->
    <a-entity id="anchor-root-hiro" visible="false"></a-entity>
    <a-entity id="anchor-root-kanji" visible="false"></a-entity>

    <!-- å°„çº¿æ‹¾å– -->
    <a-entity id="mouse" cursor="rayOrigin: mouse" raycaster="objects: .dropzone; interval: 0"></a-entity>
    <a-entity camera></a-entity>
  </a-scene>

  <div id="ui">
    <form id="form">
      <label>Text <input id="msg" placeholder="è¾“å…¥æ–‡æœ¬â€¦" maxlength="80" /></label>
      <label>Scale <input id="scale" type="number" step="0.1" value="1.0" inputmode="decimal" /></label>
      <button type="submit" id="submit">æäº¤ / Pin</button>
    </form>
    <div id="status">æœªé€‰ä½ç½®</div>
  </div>

  <script type="module">
    /******** DOM & çŠ¶æ€ ********/
    const $scan = document.getElementById('scanStatus');
    const $net  = document.getElementById('net');
    const $debug= document.getElementById('debug');
    const scene = document.getElementById('scene');
    const mouse = document.getElementById('mouse');
    const $form = document.getElementById('form');
    const $msg  = document.getElementById('msg');
    const $scale= document.getElementById('scale');
    const $stat = document.getElementById('status');
    const $btn  = document.getElementById('submit');
    const $start= document.getElementById('startAR');

    const setNet = on => $net.textContent = on ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿';
    const setDebug = txt => $debug.textContent = txt;
    setNet(navigator.onLine); addEventListener('online',()=>setNet(true)); addEventListener('offline',()=>setNet(false));
    const vibrate = (n=20)=>{ try{ navigator.vibrate && navigator.vibrate(n);}catch{} };

    // æ‰«ææç¤ºï¼ˆèŠ‚æµï¼‰
    let _scanTimer=null, _scanCache='';
    function setScan(txt, cls=''){
      if (txt===_scanCache) return;
      clearTimeout(_scanTimer);
      _scanTimer = setTimeout(()=>{ _scanCache = txt; $scan.className = cls; $scan.textContent = txt; }, 100);
    }

    /******** å¯åŠ¨ ARï¼ˆå…ˆè¦æƒé™â†’é‡Šæ”¾â†’å†è®© AR.js æ¥ç®¡ï¼‰ ********/
    const ARJS_ATTR = `
      sourceType: webcam;
      videoTexture: false;
      detectionMode: mono;
      sourceWidth: 1280;
      sourceHeight: 720;
      maxDetectionRate: 60;
      debugUIEnabled: true
    `;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    function forceVideoVisible(){
      const videos = document.querySelectorAll('video');
      videos.forEach(v=>{ v.setAttribute('playsinline','true'); v.setAttribute('webkit-playsinline','true'); v.muted = true;
        v.style.display='block'; v.style.visibility='visible'; v.style.opacity='1'; });
      const canvas = document.querySelector('.a-canvas'); if(canvas){ canvas.style.zIndex='1'; canvas.style.background='transparent'; }
    }

    $start.addEventListener('click', async () => {
      try {
        setScan('ğŸ“· æ­£åœ¨è¯·æ±‚ç›¸æœºæƒé™â€¦');
        const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
        s.getTracks().forEach(t => t.stop());
        await new Promise(r => setTimeout(r, 300));
        scene.setAttribute('arjs', ARJS_ATTR);
        scene.style.display = 'block';
        $start.style.display = 'none';
        document.getElementById('ui').style.display = 'block';
        setScan('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanjiâ€¦');
        setTimeout(forceVideoVisible, 600);
        if (isIOS){ [1500, 3000, 5000].forEach(t=>setTimeout(forceVideoVisible, t)); }
      } catch (e) {
        console.error(e);
        setScan('âŒ éœ€è¦æ‘„åƒå¤´æƒé™æ‰èƒ½ä½¿ç”¨ AR', 'error');
        alert('éœ€è¦ç›¸æœºæƒé™æ‰èƒ½ä½¿ç”¨ AR');
      }
    });

    /******** â€œç²˜æ€§é”šç‚¹ + ä¸¢å¤±ä¿æ´»â€ ********/
    const HOLD_MS = 5000; // ä¸¢å¤±åä¿æ´» 5 ç§’
    const anchors = {
      hiro:  { marker: document.getElementById('marker-hiro'),  root: document.getElementById('anchor-root-hiro'),
               detected:false, lastSeen:0, holdUntil:0, consecutiveVisible:0 },
      kanji: { marker: document.getElementById('marker-kanji'), root: document.getElementById('anchor-root-kanji'),
               detected:false, lastSeen:0, holdUntil:0, consecutiveVisible:0 },
    };

    function copyWorldTransform(fromObj3D, toObj3D){
      // æŠŠ from çš„ä¸–ç•ŒçŸ©é˜µåˆ†è§£ç»™ toï¼ˆä½ç½®/æ—‹è½¬/ç¼©æ”¾ï¼‰
      fromObj3D.updateMatrixWorld(true);
      const m = fromObj3D.matrixWorld;
      m.decompose(toObj3D.position, toObj3D.quaternion, toObj3D.scale);
    }

    function onFound(name){
      const A = anchors[name]; if (!A) return;
      if (!A.detected){ A.detected = true; vibrate(15); }
      A.lastSeen = Date.now(); A.holdUntil = A.lastSeen + HOLD_MS; A.consecutiveVisible++;
      // æŠŠå½“å‰ Marker å§¿æ€å¤åˆ¶åˆ°é”šç‚¹æ ¹ï¼Œå¹¶æ˜¾ç¤ºå®ƒ
      copyWorldTransform(A.marker.object3D, A.root.object3D);
      A.root.setAttribute('visible', true);
      updateScanStatus();
    }
    function onLost(name){
      const A = anchors[name]; if (!A) return;
      // ä¸ç«‹åˆ»éšè— rootï¼Œè€Œæ˜¯ç­‰ hold æ—¶é—´è¿‡äº†å†éšè—
      A.detected = false; A.consecutiveVisible = 0;
      updateScanStatus();
    }

    // äº‹ä»¶
    anchors.hiro.marker.addEventListener('markerFound', ()=>onFound('hiro'));
    anchors.kanji.marker.addEventListener('markerFound',()=>onFound('kanji'));
    anchors.hiro.marker.addEventListener('markerLost', ()=>onLost('hiro'));
    anchors.kanji.marker.addEventListener('markerLost',()=>onLost('kanji'));

    // è½®è¯¢å¢å¼ºï¼ˆåŒæ­¥å§¿æ€ + ä¿æ´»æ§åˆ¶ï¼‰
    let pollCount=0; const DETECT=3, HARD_LOST_TIMEOUT=2000;
    setInterval(()=>{
      pollCount++;
      const now = Date.now();
      ['hiro','kanji'].forEach(name=>{
        const A = anchors[name];
        const visible = !!(A.marker.object3D && A.marker.object3D.visible);
        if (visible){
          A.lastSeen = now; A.holdUntil = now + HOLD_MS; A.consecutiveVisible++;
          if (!A.detected && A.consecutiveVisible>=DETECT) A.detected = true;
          // å®æ—¶æŠŠ Marker å§¿æ€æ‹·åˆ° root
          copyWorldTransform(A.marker.object3D, A.root.object3D);
          A.root.setAttribute('visible', true);
        }else{
          A.consecutiveVisible = 0;
          // åœ¨ä¿æ´»æœŸå†…ï¼šä¿æŒ root å¯è§ & å§¿æ€ä¸å†å˜åŒ–
          if (now <= A.holdUntil){
            A.root.setAttribute('visible', true);
          }else{
            // è¶…è¿‡ä¿æ´»ï¼šå¦‚æœé•¿æœŸä¸å¯è§ï¼Œå†å½»åº•éšè—
            if (now - A.lastSeen > HARD_LOST_TIMEOUT){
              A.root.setAttribute('visible', false);
            }
          }
        }
      });

      setDebug(`è½®è¯¢:${pollCount}
Hiro: ${anchors.hiro.marker.object3D.visible?'âœ…å¯è§':'âŒéšè—'}  ä¿æ´»è‡³:${Math.max(0,anchors.hiro.holdUntil - Date.now())}ms
Kanji:${anchors.kanji.marker.object3D.visible?'âœ…å¯è§':'âŒéšè—'}  ä¿æ´»è‡³:${Math.max(0,anchors.kanji.holdUntil - Date.now())}ms`);
      updateScanStatus();
    }, 120);

    function updateScanStatus(){
      const names = ['hiro','kanji'].filter(n=>{
        const A = anchors[n];
        return A.marker.object3D.visible || Date.now() <= A.holdUntil; // åªè¦åœ¨ä¿æ´»æœŸä¹Ÿç®—â€œå·²è¯†åˆ«â€
      }).map(n=>n[0].toUpperCase()+n.slice(1));

      if (names.length>0){
        const holding = ['hiro','kanji'].some(n=>!anchors[n].marker.object3D.visible && Date.now()<=anchors[n].holdUntil);
        setScan( holding ? `âœ… å·²è¯†åˆ«ï¼ˆä¿æ´»ä¸­ï¼‰${names.join(' / ')}` : `âœ… å·²è¯†åˆ« ${names.join(' / ')}`, 'success');
      }else{
        setScan('ğŸ” æ­£åœ¨æ‰«æ Hiro / Kanjiâ€¦');
      }
    }

    /******** ç‚¹å‡»æ‹¾å–ï¼ˆä½¿ç”¨â€œé”šç‚¹æ ¹â€ä½œä¸ºçˆ¶èŠ‚ç‚¹ï¼‰ ********/
    const USER_ID = 'user_' + Math.random().toString(36).slice(2,8);
    let CURRENT = { anchor:null, pos:null };

    const round2 = n => Math.round(n*100)/100;
    const norm   = (x,y,z)=>[round2(x), Math.max(round2(y),0)+0.001, round2(z)];

    function worldToLocalInRoot(anchorName, worldPoint){
      const root = anchors[anchorName].root.object3D;
      const p = worldPoint.clone();
      return norm(root.worldToLocal(p).x, root.worldToLocal(worldPoint.clone()).y, root.worldToLocal(worldPoint.clone()).z);
    }

    function showPreview(anchor, pos, ok=false){
      const parent = anchors[anchor].root; if(!parent) return;
      let cur = document.getElementById(`cursor-${anchor}`);
      if(!cur){ cur = document.createElement('a-entity'); cur.id=`cursor-${anchor}`; parent.appendChild(cur); }
      cur.setAttribute('rotation','-90 0 0');
      cur.setAttribute('geometry', ok? 'primitive:ring; radiusInner:0.015; radiusOuter:0.025' : 'primitive:ring; radiusInner:0.012; radiusOuter:0.02');
      cur.setAttribute('material', ok? 'color:#00FF00; opacity:1' : 'color:#FFD166; opacity:.95');
      cur.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);

      let prev = document.getElementById(`preview-${anchor}`);
      if(!prev){ prev = document.createElement('a-entity'); prev.id=`preview-${anchor}`; parent.appendChild(prev); }
      const msg = $msg.value || '';
      const base = anchor==='hiro' ? '#90EE90' : '#FFD166';
      const color= ok ? '#00FF00' : base;
      const sc = parseFloat($scale.value||'1')||1;
      prev.setAttribute('rotation','-90 0 0');
      prev.setAttribute('text', `value:${ok?'âœ“ ':''}${msg}; align:center; width:1.8; color:${color}; wrapCount:24`);
      prev.setAttribute('material','opacity:.85; transparent:true');
      prev.setAttribute('scale', `${sc} ${sc} ${sc}`);
      prev.setAttribute('position', `${pos[0]} ${pos[1]} ${pos[2]}`);
    }

    scene.addEventListener('click', ()=>{
      const rc = mouse.components.raycaster;
      if(!rc || !rc.intersections?.length) return;
      const hit = rc.intersections[0];
      if(!hit.object?.el?.classList?.contains('dropzone')) return;

      // æ‰¾åˆ°å½’å±çš„ anchor åç§°
      const markerEl = (function findMarker(el){ let p=el; while(p && p.tagName){ if(p.tagName.toLowerCase()==='a-marker') return p; p=p.parentEl; } return null; })(hit.object.el);
      if(!markerEl) return;

      const anchor = (markerEl.id==='marker-hiro')?'hiro':'kanji';

      // å…³é”®ï¼šç‚¹å‡»æ—¶å¿…é¡»åœ¨â€œå¯è§æˆ–ä¿æ´»ä¸­â€
      const A = anchors[anchor];
      const okToPick = markerEl.object3D.visible || Date.now()<=A.holdUntil;
      if (!okToPick){
        setScan('âš ï¸ æ ‡è®°æœªè¢«ç¨³å®šè¯†åˆ«ï¼Œè¯·æŠŠæ•´å¼ æ ‡è®°æ”¾å…¥å–æ™¯æ¡†', 'error');
        setTimeout(updateScanStatus, 1200);
        return;
      }

      // ç¡®ä¿ç‚¹å‡»ç¬é—´æŠŠ Marker æœ€æ–°å§¿æ€åŒæ­¥åˆ°é”šç‚¹æ ¹
      if (markerEl.object3D.visible) copyWorldTransform(markerEl.object3D, A.root.object3D);

      // ç”¨â€œé”šç‚¹æ ¹â€çš„å±€éƒ¨åæ ‡ä¿å­˜ pin ä½ç½®ï¼ˆè¿™æ ·ä¿æ´»æ—¶ä¹Ÿèƒ½ç»§ç»­æ˜¾ç¤ºï¼‰
      const localPos = (()=>{
        const root = A.root.object3D;
        const wp = hit.point.clone();
        const lp = root.worldToLocal(wp);
        return norm(lp.x, lp.y, lp.z);
      })();

      CURRENT = { anchor, pos: localPos };
      $stat.textContent = `å·²é€‰ï¼š${anchor} (${localPos.map(n=>n.toFixed(2)).join(', ')})`;
      showPreview(anchor, localPos);
      vibrate(30);
    });

    /******** Firebase å®æ—¶åŒæ­¥ï¼ˆæŠŠå…ƒç´ æŒ‚åˆ° anchor-root-* ä¸‹ï¼‰ ********/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBYsPxSPvpv8mPQdVGJuzE2TKZ0qY6e608",
      authDomain: "ar-maker-share.firebaseapp.com",
      projectId: "ar-maker-share",
      storageBucket: "ar-maker-share.appspot.com",
      messagingSenderId: "68968164615",
      appId: "1:68968164615:web:c56d3c17046ff51ebf29a2"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const pins = collection(db, "pins");

    const q = query(pins, orderBy('ts','asc'));
    onSnapshot(q, (snap)=>{
      snap.docChanges().forEach(ch=>{
        const d = ch.doc.data();
        if(d.mode!=='arjs') return;
        const anchor = (d.anchor==='kanji')?'kanji':'hiro';
        const parent = anchors[anchor].root; if(!parent) return;

        if(ch.type==='removed'){ const old=document.getElementById(`pin-${ch.doc.id}`); if(old) old.remove(); return; }
        let el = document.getElementById(`pin-${ch.doc.id}`);
        if(!el){ el=document.createElement('a-entity'); el.id=`pin-${ch.doc.id}`; parent.appendChild(el); }
        const [x,y,z] = d.pos || [0,0,0];
        el.setAttribute('position', `${x} ${y} ${z}`);

        if(d.modelUrl){
          el.removeAttribute('text');
          const s=d.scale||1; el.setAttribute('gltf-model', d.modelUrl); el.setAttribute('scale', `${s} ${s} ${s}`);
        }else{
          const mine = d.userId===USER_ID;
          const base = anchor==='hiro' ? '#90EE90' : '#FFD166';
          const color= mine ? base : '#ccc';
          const s=d.scale||1;
          el.setAttribute('rotation','-90 0 0'); // è´´åœ¨å¹³é¢
          el.setAttribute('text', `value:${d.text||''}; align:center; width:1.8; color:${color}; wrapCount:24`);
          el.setAttribute('scale', `${s} ${s} ${s}`);
        }
      });
    });

    async function savePin({anchor,pos,text,scale}){
      return await addDoc(pins, {
        mode:'arjs', anchor, pos, text, scale, userId: USER_ID, ts: serverTimestamp()
      });
    }

    $form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const msg = ($msg.value||'').trim();
      const sc  = parseFloat($scale.value||'1')||1;
      if(!msg) return alert('è¯·è¾“å…¥æ–‡æœ¬');
      if(!CURRENT.pos) return alert('è¯·å…ˆåœ¨æ ‡è®°é™„è¿‘ç‚¹å‡»é€‰æ‹©ä½ç½®');
      if(!navigator.onLine) return alert('ç¦»çº¿çŠ¶æ€ï¼Œæ— æ³•æäº¤');

      const {anchor,pos} = CURRENT;
      try{
        $btn.disabled = true;
        showPreview(anchor,pos,true); setScan('â³ æ­£åœ¨æäº¤â€¦');
        await savePin({anchor,pos,text:msg,scale:sc});
        setScan('âœ… å·²æäº¤ï¼Œå…¶ä»–äººä¹Ÿèƒ½çœ‹åˆ°','success');
        $msg.value='';
        vibrate(50);
        setTimeout(()=>{
          ['preview-','cursor-'].forEach(p=>{ const el=document.getElementById(p+anchor); if(el) el.remove(); });
          $stat.textContent='å°±ç»ª';
        }, 1600);
        CURRENT = { anchor:null, pos:null };
      }catch(err){
        console.error(err); setScan('âŒ æäº¤å¤±è´¥','error'); showPreview(anchor,pos,false);
      }finally{
        setTimeout(()=>{ $btn.disabled=false; }, 800);
      }
    });

    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(()=>{ 
      // å›å‰å°è¡¥ä¸€æ¬¡å¯è§æ€§ä¿®å¤
      forceVideoVisible();
    }, 400); });
  </script>
</body>
</html>
