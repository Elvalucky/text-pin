<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>AR.js Marker Scan Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- æ›´æ–°åçš„CDNé“¾æ¥ -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.3/aframe/build/aframe-ar.js"></script>
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100dvh;
      background: transparent;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* é˜²æ­¢æ„å¤–ç¼©æ”¾å’Œé€‰æ‹© */
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    #scanStatus {
      position: fixed;
      top: 8px;
      left: 8px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      backdrop-filter: blur(8px);
      transition: all 0.3s ease;
      max-width: calc(100vw - 32px);
      box-sizing: border-box;
    }

    #scanStatus.success {
      background: rgba(34, 197, 94, 0.8);
    }

    #scanStatus.error {
      background: rgba(239, 68, 68, 0.8);
    }

    #scanStatus.loading {
      background: rgba(59, 130, 246, 0.8);
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 6px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* å…¼å®¹æ€§è­¦å‘Š */
    #compatibilityWarning {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      max-width: 300px;
      display: none;
    }

    /* æƒé™è¯·æ±‚æç¤º */
    #permissionPrompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      z-index: 10;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 16px;
      border-radius: 12px;
      text-align: center;
      display: none;
      backdrop-filter: blur(8px);
    }

    /* éšè—A-Frameçš„VRæŒ‰é’®å’Œé»˜è®¤UI */
    .a-enter-vr-button,
    .a-enter-ar-button,
    .a-orientation-modal {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- çŠ¶æ€æç¤º -->
  <div id="scanStatus" class="loading">
    <span class="loading-spinner"></span>åˆå§‹åŒ–ARç³»ç»Ÿ...
  </div>

  <!-- å…¼å®¹æ€§è­¦å‘Š -->
  <div id="compatibilityWarning">
    <h3>âš ï¸ è®¾å¤‡ä¸å…¼å®¹</h3>
    <p id="compatibilityMessage"></p>
    <button onclick="hideCompatibilityWarning()" style="
      background: #4CAF50; 
      color: white; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 6px; 
      margin-top: 10px;
      cursor: pointer;
    ">çŸ¥é“äº†</button>
  </div>

  <!-- æƒé™è¯·æ±‚æç¤º -->
  <div id="permissionPrompt">
    <p>ğŸ“· éœ€è¦æ‘„åƒå¤´æƒé™æ‰èƒ½ä½¿ç”¨ARåŠŸèƒ½ï¼Œè¯·ç‚¹å‡»"å…è®¸"</p>
  </div>

  <!-- AR.js åœºæ™¯ -->
  <a-scene
    id="arScene"
    embedded
    vr-mode-ui="enabled: false"
    renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true; antialias: true"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; trackingMethod: best; maxDetectionRate: 60; canvasWidth: 640; canvasHeight: 480"
    style="display: none;">
    
    <!-- ç¯å¢ƒå…‰å’Œæ–¹å‘å…‰ -->
    <a-entity light="type: ambient; intensity: 0.6"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0.5 1 0.5"></a-entity>
    
    <!-- Hiro marker -->
    <a-marker id="marker-hiro" preset="hiro">
      <a-box 
        position="0 0.5 0" 
        material="color: #ff4444; roughness: 0.3; metalness: 0.1" 
        animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"
        shadow="cast: true">
      </a-box>
      <a-text 
        value="HIRO" 
        position="0 1.2 0" 
        align="center" 
        color="#ffffff" 
        scale="2 2 2">
      </a-text>
    </a-marker>
    
    <!-- Kanji marker -->
    <a-marker id="marker-kanji" preset="kanji">
      <a-sphere 
        position="0 0.5 0" 
        radius="0.5" 
        material="color: #4444ff; roughness: 0.2; metalness: 0.2"
        animation="property: scale; to: 1.2 1.2 1.2; direction: alternate; loop: true; dur: 2000"
        shadow="cast: true">
      </a-sphere>
      <a-text 
        value="KANJI" 
        position="0 1.2 0" 
        align="center" 
        color="#ffffff" 
        scale="2 2 2">
      </a-text>
    </a-marker>
    
    <!-- æ‘„åƒæœº -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // å…¨å±€å˜é‡
    const badge = document.getElementById('scanStatus');
    const scene = document.getElementById('arScene');
    const compatibilityWarning = document.getElementById('compatibilityWarning');
    const permissionPrompt = document.getElementById('permissionPrompt');
    
    let isInitialized = false;
    let markersFound = new Set();

    // å·¥å…·å‡½æ•°ï¼šé˜²æŠ–
    function debounce(func, delay) {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func(...args), delay);
      };
    }

    // å·¥å…·å‡½æ•°ï¼šå®‰å…¨çš„éœ‡åŠ¨åé¦ˆ
    function vibrate(duration = 50) {
      try {
        if (navigator.vibrate && typeof navigator.vibrate === 'function') {
          navigator.vibrate(duration);
        }
      } catch (e) {
        console.warn('æŒ¯åŠ¨APIä¸å¯ç”¨:', e);
      }
    }

    // å…¼å®¹æ€§æ£€æŸ¥
    function checkCompatibility() {
      const issues = [];
      
      // æ£€æŸ¥WebGLæ”¯æŒ
      if (!window.WebGLRenderingContext) {
        issues.push('WebGLä¸æ”¯æŒ - ARåŠŸèƒ½éœ€è¦ç¡¬ä»¶åŠ é€Ÿ');
      }
      
      // æ£€æŸ¥æ‘„åƒå¤´API
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        issues.push('æ‘„åƒå¤´APIä¸æ”¯æŒ - æ— æ³•è®¿é—®ç›¸æœº');
      }
      
      // æ£€æŸ¥åŸºç¡€Web API
      if (!window.requestAnimationFrame) {
        issues.push('åŠ¨ç”»APIä¸æ”¯æŒ - æ€§èƒ½å¯èƒ½å—å½±å“');
      }

      // æ£€æŸ¥HTTPSï¼ˆæ‘„åƒå¤´æƒé™è¦æ±‚ï¼‰
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        issues.push('éœ€è¦HTTPSè¿æ¥æ‰èƒ½è®¿é—®æ‘„åƒå¤´');
      }
      
      return issues;
    }

    // æ˜¾ç¤ºå…¼å®¹æ€§è­¦å‘Š
    function showCompatibilityWarning(issues) {
      const message = issues.join('\nâ€¢ ');
      document.getElementById('compatibilityMessage').textContent = 'æ£€æµ‹åˆ°ä»¥ä¸‹é—®é¢˜ï¼š\nâ€¢ ' + message;
      compatibilityWarning.style.display = 'block';
    }

    // éšè—å…¼å®¹æ€§è­¦å‘Š
    function hideCompatibilityWarning() {
      compatibilityWarning.style.display = 'none';
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(message, type = 'default') {
      badge.className = type;
      
      if (type === 'loading') {
        badge.innerHTML = `<span class="loading-spinner"></span>${message}`;
      } else {
        badge.textContent = message;
      }
    }

    // æ ‡è®°æ‰¾åˆ°å¤„ç†
    const handleMarkerFound = debounce((name) => {
      markersFound.add(name);
      updateStatus(`âœ… å·²è¯†åˆ« ${name} æ ‡è®°`, 'success');
      vibrate(30);
    }, 100);

    // æ ‡è®°ä¸¢å¤±å¤„ç†
    const handleMarkerLost = debounce(() => {
      if (markersFound.size === 0) {
        updateStatus('ğŸ” è¯·å°†æ‘„åƒå¤´å¯¹å‡† Hiro æˆ– Kanji æ ‡è®°', 'default');
      }
    }, 200);

    // AR.js äº‹ä»¶å¤„ç†
    function setupAREvents() {
      const hiro = document.getElementById('marker-hiro');
      const kanji = document.getElementById('marker-kanji');
      
      if (!hiro || !kanji) {
        console.error('æ ‡è®°å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      // æ ‡è®°äº‹ä»¶ç›‘å¬
      hiro.addEventListener('markerFound', () => handleMarkerFound('Hiro'));
      kanji.addEventListener('markerFound', () => handleMarkerFound('Kanji'));
      
      hiro.addEventListener('markerLost', () => {
        markersFound.delete('Hiro');
        handleMarkerLost();
      });
      
      kanji.addEventListener('markerLost', () => {
        markersFound.delete('Kanji');
        handleMarkerLost();
      });
    }

    // åˆå§‹åŒ–ARç³»ç»Ÿ
    async function initializeAR() {
      try {
        updateStatus('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...', 'loading');
        
        // æ˜¾ç¤ºæƒé™æç¤º
        permissionPrompt.style.display = 'block';
        
        // è¯·æ±‚æ‘„åƒå¤´æƒé™
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 640 },
            height: { ideal: 480 }
          } 
        });
        
        // ç«‹å³åœæ­¢æµï¼ŒAR.jsä¼šé‡æ–°è·å–
        stream.getTracks().forEach(track => track.stop());
        
        // éšè—æƒé™æç¤º
        permissionPrompt.style.display = 'none';
        
        updateStatus('æ­£åœ¨åˆå§‹åŒ–ARç³»ç»Ÿ...', 'loading');
        
        // æ˜¾ç¤ºARåœºæ™¯
        scene.style.display = 'block';
        
        // ç­‰å¾…A-Frameå®Œå…¨åŠ è½½
        if (scene.hasLoaded) {
          setupAREvents();
          onARReady();
        } else {
          scene.addEventListener('loaded', () => {
            setupAREvents();
            onARReady();
          });
        }
        
      } catch (error) {
        permissionPrompt.style.display = 'none';
        console.error('ARåˆå§‹åŒ–å¤±è´¥:', error);
        
        if (error.name === 'NotAllowedError') {
          updateStatus('âŒ æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·åˆ·æ–°é¡µé¢å¹¶å…è®¸è®¿é—®', 'error');
        } else if (error.name === 'NotFoundError') {
          updateStatus('âŒ æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡', 'error');
        } else if (error.name === 'NotReadableError') {
          updateStatus('âŒ æ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨', 'error');
        } else {
          updateStatus('âŒ ARåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
      }
    }

    // ARå‡†å¤‡å®Œæˆ
    function onARReady() {
      isInitialized = true;
      updateStatus('ğŸ” è¯·å°†æ‘„åƒå¤´å¯¹å‡† Hiro æˆ– Kanji æ ‡è®°', 'default');
      
      // ç›‘å¬AR.jsçš„videoäº‹ä»¶
      setTimeout(() => {
        const video = document.querySelector('video');
        if (video) {
          video.addEventListener('loadedmetadata', () => {
            console.log('æ‘„åƒå¤´è§†é¢‘æµå·²å°±ç»ª');
          });
        }
      }, 1000);
    }

    // é”™è¯¯å¤„ç†
    window.addEventListener('error', (e) => {
      console.error('å…¨å±€é”™è¯¯:', e.error);
      if (!isInitialized) {
        updateStatus('âŒ åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', async () => {
      // æ£€æŸ¥å…¼å®¹æ€§
      const compatibilityIssues = checkCompatibility();
      
      if (compatibilityIssues.length > 0) {
        console.warn('å…¼å®¹æ€§é—®é¢˜:', compatibilityIssues);
        showCompatibilityWarning(compatibilityIssues);
        
        // ä¸¥é‡å…¼å®¹æ€§é—®é¢˜åˆ™ä¸ç»§ç»­åˆå§‹åŒ–
        if (compatibilityIssues.some(issue => 
          issue.includes('WebGL') || 
          issue.includes('æ‘„åƒå¤´API') || 
          issue.includes('HTTPS')
        )) {
          updateStatus('âŒ è®¾å¤‡ä¸æ”¯æŒARåŠŸèƒ½', 'error');
          return;
        }
      }

      // ç­‰å¾…A-FrameåŠ è½½å®Œæˆ
      if (typeof AFRAME === 'undefined') {
        updateStatus('âŒ ARåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
        return;
      }

      // åˆå§‹åŒ–ARç³»ç»Ÿ
      await initializeAR();
    });

    // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // é¡µé¢éšè—æ—¶æš‚åœ
        markersFound.clear();
      } else if (isInitialized) {
        // é¡µé¢é‡æ–°å¯è§æ—¶é‡ç½®çŠ¶æ€
        updateStatus('ğŸ” è¯·å°†æ‘„åƒå¤´å¯¹å‡† Hiro æˆ– Kanji æ ‡è®°', 'default');
      }
    });

    // æš´éœ²å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
    window.hideCompatibilityWarning = hideCompatibilityWarning;
  </script>
</body>
</html>
